<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Par치metros del Sistema - Administraci칩n</title>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Cargar tema guardado inmediatamente para evitar flash
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            const colorTheme = localStorage.getItem('colorTheme') || 'rubi';
            document.documentElement.setAttribute('data-color-theme', colorTheme);
            // Crear favicon desde localStorage (sin link est치tico para evitar flash)
            const faviconUrl = localStorage.getItem('faviconUrl');
            if (faviconUrl) {
                const link = document.createElement('link');
                link.rel = 'icon';
                link.href = faviconUrl;
                document.head.appendChild(link);
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header de la p치gina -->
        <div class="page-header">
            <div class="logo-section">
                <a href="#" onclick="goBack(); return false;" style="display: flex; align-items: center;">
                    <img src="" alt="Logo" class="logo" style="cursor: pointer; visibility: hidden;">
                </a>
                <h1 data-i18n="menu.parameters">Par치metros</h1>
            </div>
            <div class="header-actions">
                <button class="back-btn" onclick="goBack()">
                    <span data-i18n="proposals.backToStocks">Volver a Stocks</span>
                </button>
            </div>
        </div>

        <!-- Contenedor principal -->
        <div class="params-container">
            <div class="params-content">
                <div class="info-box">
                    <p>Los par치metros del sistema controlan el comportamiento de la aplicaci칩n. Los cambios se aplican inmediatamente.</p>
                </div>

                <!-- Loading state -->
                <div class="params-loading" id="params-loading">
                    <div class="spinner"></div>
                    <p data-i18n="common.loading">Cargando...</p>
                </div>

                <!-- Empty state -->
                <div class="params-empty" id="params-empty" style="display: none;">
                    <div class="params-empty-icon">丘뙖잺</div>
                    <h3>No hay par치metros configurados</h3>
                </div>

                <!-- Lista de par치metros -->
                <div class="params-list" id="params-list" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js"></script>
    <script>
        // ==================== CONFIGURACI칍N ====================
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
        const API_URL = isLocalhost ? `${protocol}//${hostname}:5000` : `${protocol}//${hostname}`;

        // ==================== LOGO DIN츼MICO POR EMPRESA ====================
        function applyColorTheme(tema) {
            const validThemes = ['rubi', 'zafiro', 'esmeralda', 'amatista', 'ambar', 'grafito'];
            if (!validThemes.includes(tema)) tema = 'rubi';
            document.documentElement.setAttribute('data-color-theme', tema);
            localStorage.setItem('colorTheme', tema);
        }

        async function cargarLogoEmpresa() {
            // Usar connection (empresa_cli_id) para endpoints de logo
            const connection = localStorage.getItem('connection');
            if (!connection) {
                console.warn('No hay connection en localStorage, usando valores por defecto');
                applyColorTheme('rubi');
                return;
            }
            const logoElements = document.querySelectorAll('.logo');
            try {
                const configResponse = await fetch(`${API_URL}/api/empresa/${connection}/config`);
                const config = await configResponse.json();
                applyColorTheme(config.tema || 'rubi');
                const invertirFilter = config.invertir_logo ? 'brightness(0) invert(1)' : 'none';
                if (config.tiene_logo) {
                    const logoUrl = `${API_URL}/api/empresa/${connection}/logo?t=${Date.now()}`;
                    logoElements.forEach(el => {
                        el.src = logoUrl;
                        el.style.filter = invertirFilter;
                        el.style.visibility = 'visible';
                    });
                } else {
                    logoElements.forEach(el => {
                        el.src = 'assets/logo.svg';
                        el.style.filter = 'brightness(0) invert(1)';
                        el.style.visibility = 'visible';
                    });
                }
            } catch (error) {
                console.log('Error al cargar logo:', error);
                applyColorTheme('rubi');
                logoElements.forEach(el => {
                    el.src = 'assets/logo.svg';
                    el.style.filter = 'brightness(0) invert(1)';
                    el.style.visibility = 'visible';
                });
            }
        }

        let params = [];
        let csrfToken = null;

        // ==================== DEFINICI칍N DE SECCIONES ====================
        const PARAM_SECTIONS = {
            design: {
                title: 'Dise침o',
                titleKey: 'params.sectionDesign',
                icon: '游꿛',
                description: 'Configuraci칩n visual de la aplicaci칩n',
                descKey: 'params.sectionDesignDesc',
                params: ['GRID_CON_IMAGENES', 'PAGINACION_GRID', 'PAGINACION_LIMITE']
            },
            features: {
                title: 'Funcionalidades',
                titleKey: 'params.sectionFeatures',
                icon: '丘뙖잺',
                description: 'Control de caracter칤sticas del sistema',
                descKey: 'params.sectionFeaturesDesc',
                params: ['WHATSAPP_NUMERO', 'PERMITIR_REGISTRO', 'PERMITIR_PROPUESTAS', 'PERMITIR_FIRMA']
            },
            other: {
                title: 'Otros',
                titleKey: 'params.sectionOther',
                icon: '游늶',
                description: 'Par치metros adicionales del sistema',
                descKey: 'params.sectionOtherDesc',
                params: [] // Se rellenar치 con los que no est칠n en otras secciones
            }
        };

        // ==================== CSRF TOKEN ====================
        async function obtenerCsrfToken() {
            try {
                // Primero intentar obtener de localStorage
                csrfToken = localStorage.getItem('csrf_token');

                // Luego obtener del servidor (puede ser m치s reciente)
                const response = await fetch(`${API_URL}/api/csrf-token`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    csrfToken = data.csrf_token;
                    localStorage.setItem('csrf_token', csrfToken);
                }
            } catch (e) {
                console.error('Error obteniendo CSRF token:', e);
            }
        }

        // ==================== INICIALIZACI칍N ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar logo de empresa (usa connection de localStorage)
            await cargarLogoEmpresa();

            // Inicializar i18n
            await I18n.init();

            // Actualizar selector de idioma
            const langSelector = document.getElementById('lang-selector');
            if (langSelector) {
                langSelector.value = I18n.currentLang;
            }

            // Verificar autenticaci칩n y permisos
            await checkAuth();

            // Obtener CSRF token
            await obtenerCsrfToken();

            // Cargar par치metros
            await loadParams();
        });

        // ==================== AUTENTICACI칍N ====================
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/api/current-user`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = await response.json();

                // Verificar que sea administrador o superusuario
                if (user.rol !== 'administrador' && user.rol !== 'superusuario') {
                    alert('No tienes permisos para acceder a esta p치gina');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = 'login.html';
            }
        }

        // ==================== CARGAR PAR츼METROS ====================
        async function loadParams() {
            const loadingEl = document.getElementById('params-loading');
            const emptyEl = document.getElementById('params-empty');
            const listEl = document.getElementById('params-list');
            const empresaId = localStorage.getItem('empresa_id') || '1';

            try {
                const response = await fetch(`${API_URL}/api/parametros?empresa_id=${empresaId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error loading params');
                }

                const data = await response.json();
                params = data.parametros || [];

                loadingEl.style.display = 'none';

                if (params.length === 0) {
                    emptyEl.style.display = 'block';
                    listEl.style.display = 'none';
                } else {
                    emptyEl.style.display = 'none';
                    listEl.style.display = 'flex';
                    renderParams();
                }
            } catch (error) {
                console.error('Error loading params:', error);
                loadingEl.innerHTML = `<p style="color: #dc3545;">Error al cargar los par치metros</p>`;
            }
        }

        // ==================== RENDERIZAR PAR츼METROS ====================
        function renderParams() {
            const listEl = document.getElementById('params-list');

            // Identificar par치metros que no est치n en ninguna secci칩n definida
            const allDefinedParams = [];
            for (const section of Object.values(PARAM_SECTIONS)) {
                if (section.params) {
                    allDefinedParams.push(...section.params);
                }
            }

            // A침adir par치metros no definidos a la secci칩n "other"
            PARAM_SECTIONS.other.params = params
                .map(p => p.clave)
                .filter(clave => !allDefinedParams.includes(clave));

            let html = '';

            for (const [sectionKey, section] of Object.entries(PARAM_SECTIONS)) {
                const sectionParams = params.filter(p => section.params.includes(p.clave));

                // Omitir secci칩n si no tiene par치metros
                if (sectionParams.length === 0) continue;

                html += `
                    <div class="param-section">
                        <div class="param-section-header">
                            <span class="param-section-icon">${section.icon}</span>
                            <div class="param-section-info">
                                <h3 data-i18n="${section.titleKey}">${section.title}</h3>
                                <p data-i18n="${section.descKey}">${section.description}</p>
                            </div>
                        </div>
                        <div class="param-section-grid">
                            ${sectionParams.map(param => renderParamCard(param)).join('')}
                        </div>
                    </div>
                `;
            }

            listEl.innerHTML = html;

            // Re-aplicar traducciones a los nuevos elementos
            if (window.I18n) {
                I18n.translatePage();
            }
        }

        // ==================== RENDERIZAR TARJETA DE PAR츼METRO ====================
        function renderParamCard(param) {
            const isBoolean = param.valor === '0' || param.valor === '1';
            const isTrue = param.valor === '1';

            return `
                <div class="param-card" data-key="${param.clave}">
                    <div class="param-info">
                        <span class="param-key">${param.clave}</span>
                        <p class="param-description">${param.descripcion || 'Sin descripci칩n'}</p>
                        <span class="param-meta">
                            <span data-i18n="params.lastModified">칔ltima modificaci칩n</span>: ${formatDate(param.fecha_modificacion)}
                        </span>
                    </div>
                    <div class="param-value-section">
                        ${isBoolean ? `
                            <label class="switch">
                                <input type="checkbox" ${isTrue ? 'checked' : ''} onchange="toggleParam('${param.clave}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span class="param-value-display ${isTrue ? 'value-true' : 'value-false'}">
                                ${isTrue ? 'Activo' : 'Inactivo'}
                            </span>
                        ` : `
                            <input type="text" class="param-input" id="input-${param.clave}" value="${param.valor}" />
                            <button class="btn-save-param" onclick="saveTextParam('${param.clave}')" data-i18n="common.save">
                                Guardar
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        // ==================== TOGGLE PAR츼METRO BOOLEANO ====================
        async function toggleParam(clave, checked) {
            const newValue = checked ? '1' : '0';
            const empresaId = localStorage.getItem('empresa_id') || '1';

            try {
                const response = await fetch(`${API_URL}/api/parametros/${clave}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ valor: newValue, empresa_id: empresaId })
                });

                if (!response.ok) {
                    throw new Error('Error updating param');
                }

                // Actualizar UI
                const card = document.querySelector(`[data-key="${clave}"]`);
                const valueDisplay = card.querySelector('.param-value-display');
                valueDisplay.textContent = checked ? 'Activo' : 'Inactivo';
                valueDisplay.className = `param-value-display ${checked ? 'value-true' : 'value-false'}`;

                // Actualizar array local
                const index = params.findIndex(p => p.clave === clave);
                if (index !== -1) {
                    params[index].valor = newValue;
                    params[index].fecha_modificacion = new Date().toISOString();
                }

                showToast('Par치metro actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error updating param:', error);
                showToast('Error al actualizar el par치metro', 'error');

                // Revertir el switch
                const card = document.querySelector(`[data-key="${clave}"]`);
                const input = card.querySelector('input[type="checkbox"]');
                input.checked = !checked;
            }
        }

        // ==================== GUARDAR PAR츼METRO DE TEXTO ====================
        async function saveTextParam(clave) {
            const input = document.getElementById(`input-${clave}`);
            const newValue = input.value;
            const empresaId = localStorage.getItem('empresa_id') || '1';

            try {
                const response = await fetch(`${API_URL}/api/parametros/${clave}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ valor: newValue, empresa_id: empresaId })
                });

                if (!response.ok) {
                    throw new Error('Error updating param');
                }

                // Actualizar array local
                const index = params.findIndex(p => p.clave === clave);
                if (index !== -1) {
                    params[index].valor = newValue;
                    params[index].fecha_modificacion = new Date().toISOString();
                }

                showToast('Par치metro actualizado correctamente', 'success');
            } catch (error) {
                console.error('Error updating param:', error);
                showToast('Error al actualizar el par치metro', 'error');
            }
        }

        // ==================== TOAST NOTIFICATION ====================
        function showToast(message, type) {
            // Remover toast existente si hay
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ==================== UTILIDADES ====================
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function goBack() {
            const empresaId = localStorage.getItem('empresa_id');
            window.location.href = `index.html?empresa=${empresaId}`;
        }
    </script>
</body>
</html>
