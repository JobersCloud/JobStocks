<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Email - Gesti√≥n de Stocks</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="js/theme-init.js?v=1.34.0"></script>
</head>
<body>
    <!-- Selector de idioma fijo -->
    <div class="lang-selector-fixed">
        <select id="lang-selector" class="lang-selector" onchange="I18n.setLanguage(this.value)">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="fr">FR</option>
        </select>
    </div>

    <div class="login-wrapper">
        <div class="login-sidebar">
            <div class="sidebar-content">
                <img id="sidebar-logo" src="/assets/logojobers.png" alt="Logo" class="sidebar-logo">
                <h2 data-i18n="header.title">Gesti√≥n de Stocks</h2>
                <p><span data-i18n="header.subtitle">Sistema de consulta de inventario en tiempo real</span></p>
            </div>
        </div>

        <div class="login-container">
            <div class="login-box">
                <img id="mobile-logo" src="/assets/logojobers.png" alt="Logo" class="mobile-logo">
                <script>
                    // Cargar logo desde localStorage inmediatamente para evitar flash
                    (function() {
                        const logoUrl = localStorage.getItem('logoUrl');
                        if (logoUrl) {
                            document.getElementById('sidebar-logo').src = logoUrl;
                            document.getElementById('mobile-logo').src = logoUrl;
                        }
                    })();
                </script>

                <div id="verify-content">
                    <div class="verify-icon loading">‚è≥</div>
                    <h1 class="verify-title" data-i18n="verification.verifying">Verificando...</h1>
                    <p class="verify-message" data-i18n="verification.verifyingMessage">Estamos verificando tu cuenta, por favor espera un momento.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/i18n/i18n.js"></script>
    <script>
        // Usar el host completo de la URL actual (incluye puerto si existe)
        const API_URL = window.location.origin;

        // Mostrar error cuando se usa par√°metro 'empresa' en lugar de 'connection'
        function showInvalidParamError() {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <div style="background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 500px; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üö´</div>
                        <h1 style="color: #333; margin-bottom: 1rem; font-size: 1.5rem;">Par√°metro Incorrecto</h1>
                        <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.6;">
                            El par√°metro <strong style="color: #e74c3c;">empresa</strong> no es v√°lido.
                            Debe usar <strong style="color: #27ae60;">connection</strong> en su lugar.
                        </p>
                        <p style="color: #999; font-size: 0.9rem;">
                            Por favor, contacte con el administrador para obtener el enlace correcto.
                        </p>
                    </div>
                </div>
            `;
        }

        // Capturar connection de la URL y guardarlo en localStorage
        function capturarConnection() {
            const urlParams = new URLSearchParams(window.location.search);

            // Si viene 'empresa' en lugar de 'connection', mostrar error
            const empresaParam = urlParams.get('empresa');
            if (empresaParam && !urlParams.get('connection')) {
                return 'INVALID_PARAM';
            }

            const connection = urlParams.get('connection');
            if (connection) {
                localStorage.setItem('connection', connection);
                console.log(`üìç Connection capturada desde verificaci√≥n: ${connection}`);
            }
            return connection || localStorage.getItem('connection') || null;
        }

        const connection = capturarConnection();

        // Verificar si hay error de par√°metro
        if (connection === 'INVALID_PARAM' || !connection) {
            showInvalidParamError();
        }

        // Aplicar tema de color
        function applyColorTheme(tema) {
            const themes = {
                'rubi': { primary: '#FF4338', primaryDark: '#D32F2F', primaryLight: '#FF6B6B' },
                'zafiro': { primary: '#2196F3', primaryDark: '#1565C0', primaryLight: '#64B5F6' },
                'esmeralda': { primary: '#4CAF50', primaryDark: '#2E7D32', primaryLight: '#81C784' },
                'amatista': { primary: '#9C27B0', primaryDark: '#6A1B9A', primaryLight: '#BA68C8' },
                'ambar': { primary: '#FF9800', primaryDark: '#E65100', primaryLight: '#FFB74D' },
                'grafito': { primary: '#607D8B', primaryDark: '#37474F', primaryLight: '#90A4AE' },
                'corporativo': { primary: '#1a365d', primaryDark: '#0d1b2a', primaryLight: '#2c5282' },
                'ejecutivo': { primary: '#2d3748', primaryDark: '#1a202c', primaryLight: '#4a5568' },
                'oceano': { primary: '#0077b6', primaryDark: '#023e8a', primaryLight: '#0096c7' },
                'bosque': { primary: '#2d6a4f', primaryDark: '#1b4332', primaryLight: '#40916c' },
                'vino': { primary: '#722f37', primaryDark: '#4a1c23', primaryLight: '#a4343a' },
                'medianoche': { primary: '#1e3a5f', primaryDark: '#0d1b2a', primaryLight: '#2e5077' },
                'titanio': { primary: '#4a5568', primaryDark: '#2d3748', primaryLight: '#718096' },
                'bronce': { primary: '#8b5a2b', primaryDark: '#5c3d1e', primaryLight: '#a0522d' },
                'elegante': { primary: '#FF4438', primaryDark: '#1a1a1a', primaryLight: '#FF6B5B' }
            };
            if (!themes[tema]) tema = 'rubi';
            const colors = themes[tema];
            document.documentElement.setAttribute('data-color-theme', tema);
            localStorage.setItem('colorTheme', tema);
            document.documentElement.style.setProperty('--primary', colors.primary, 'important');
            document.documentElement.style.setProperty('--primary-dark', colors.primaryDark, 'important');
            document.documentElement.style.setProperty('--primary-light', colors.primaryLight, 'important');
        }

        // Cargar tema de color desde la API
        async function cargarTemaColor() {
            try {
                const response = await fetch(`${API_URL}/api/empresa/${connection}/config`);
                const config = await response.json();
                applyColorTheme(config.tema || 'rubi');
            } catch (error) {
                console.log('Error cargando tema:', error);
                applyColorTheme('rubi');
            }
        }

        // Cargar logo de la empresa desde la BD
        async function cargarLogoEmpresa() {
            try {
                const response = await fetch(`${API_URL}/api/empresa/${connection}/logo/exists`);
                const data = await response.json();

                if (data.exists) {
                    const logoUrl = `${API_URL}/api/empresa/${connection}/logo`;
                    const sidebarLogo = document.getElementById('sidebar-logo');
                    const mobileLogo = document.getElementById('mobile-logo');

                    if (sidebarLogo) sidebarLogo.src = logoUrl;
                    if (mobileLogo) mobileLogo.src = logoUrl;
                }
            } catch (error) {
                console.log('Error cargando logo:', error);
            }
        }

        async function verificarEmail() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const content = document.getElementById('verify-content');

            if (!token) {
                mostrarError(t('verification.invalidToken'), t('verification.invalidTokenMessage'));
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/verify-email?token=${token}&connection=${connection}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    mostrarExito(data.message);
                } else {
                    mostrarError(t('verification.verificationError'), data.message || t('verification.couldNotVerify'));
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError(t('verification.connectionError'), t('verification.connectionErrorMessage'));
            }
        }

        function mostrarExito(mensaje) {
            const content = document.getElementById('verify-content');
            const loginUrl = '/login';
            content.innerHTML = `
                <div class="verify-icon success">‚úì</div>
                <h1 class="verify-title">${t('verification.verified')}</h1>
                <p class="verify-message">${mensaje}</p>
                <a href="${loginUrl}" class="btn-login">${t('verification.goToLogin')}</a>
            `;
        }

        function mostrarError(titulo, mensaje) {
            const content = document.getElementById('verify-content');
            const loginUrl = '/login';
            content.innerHTML = `
                <div class="verify-icon error">‚úó</div>
                <h1 class="verify-title">${titulo}</h1>
                <p class="verify-message">${mensaje}</p>
                <a href="${loginUrl}" class="btn-login">${t('verification.backToLogin')}</a>
            `;
        }

        // Inicializar: cargar tema, logo, i18n y luego verificar email
        // Solo ejecutar si hay connection v√°lido
        if (connection && connection !== 'INVALID_PARAM') {
            Promise.all([cargarTemaColor(), cargarLogoEmpresa()]).then(() => {
                I18n.init().then(() => {
                    verificarEmail();
                });
            });
        }
    </script>
</body>
</html>
