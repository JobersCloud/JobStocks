<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Gesti√≥n de Stocks</title>
    <link rel="icon" type="image/x-icon" href="/assets/faviconjobers.ico">
    <script>
        // Inyectar colores del tema ANTES del CSS para evitar flash
        (function () {
            const themes = {
                'rubi': { primary: '#FF4338', primaryDark: '#D32F2F', primaryLight: '#FF6B6B' },
                'zafiro': { primary: '#2196F3', primaryDark: '#1565C0', primaryLight: '#64B5F6' },
                'esmeralda': { primary: '#4CAF50', primaryDark: '#2E7D32', primaryLight: '#81C784' },
                'amatista': { primary: '#9C27B0', primaryDark: '#6A1B9A', primaryLight: '#BA68C8' },
                'ambar': { primary: '#FF9800', primaryDark: '#E65100', primaryLight: '#FFB74D' },
                'grafito': { primary: '#607D8B', primaryDark: '#37474F', primaryLight: '#90A4AE' },
                'corporativo': { primary: '#1a365d', primaryDark: '#0d1b2a', primaryLight: '#2c5282' },
                'ejecutivo': { primary: '#2d3748', primaryDark: '#1a202c', primaryLight: '#4a5568' },
                'oceano': { primary: '#0077b6', primaryDark: '#023e8a', primaryLight: '#0096c7' },
                'bosque': { primary: '#2d6a4f', primaryDark: '#1b4332', primaryLight: '#40916c' },
                'vino': { primary: '#722f37', primaryDark: '#4a1c23', primaryLight: '#a4343a' },
                'medianoche': { primary: '#1e3a5f', primaryDark: '#0d1b2a', primaryLight: '#2e5077' },
                'titanio': { primary: '#4a5568', primaryDark: '#2d3748', primaryLight: '#718096' },
                'bronce': { primary: '#8b5a2b', primaryDark: '#5c3d1e', primaryLight: '#a0522d' },
                'elegante': { primary: '#FF4438', primaryDark: '#1a1a1a', primaryLight: '#FF6B5B' }
            };
            const theme = localStorage.getItem('theme') || 'dark';
            const colorTheme = localStorage.getItem('colorTheme') || 'rubi';
            const colors = themes[colorTheme] || themes['rubi'];

            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-color-theme', colorTheme);

            // Inyectar colores como CSS inline con !important para ganar especificidad
            const style = document.createElement('style');
            style.id = 'theme-colors-inline';
            style.textContent = ':root{--primary:' + colors.primary + '!important;--primary-dark:' + colors.primaryDark + '!important;--primary-light:' + colors.primaryLight + '!important}';
            document.head.appendChild(style);
        })();
    </script>
    <link rel="stylesheet" href="css/styles.css?v=1.22.18">
</head>
<body>
    <!-- Selector de idioma y tema fijo -->
    <div class="login-top-controls">
        <div class="theme-toggle-login">
            <span class="theme-icon" id="theme-icon" onclick="toggleTheme()">‚òÄÔ∏è</span>
            <label class="switch">
                <input type="checkbox" id="theme-switch" checked onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <select id="lang-selector" class="lang-selector" onchange="I18n.setLanguage(this.value)">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="fr">FR</option>
        </select>
    </div>

    <div class="login-wrapper">
        <div class="login-sidebar">
            <div class="sidebar-content">
                <img id="sidebar-logo" src="assets/logojobers.png" alt="Logo" class="sidebar-logo">
                <h2 data-i18n="header.title">Gesti√≥n de Stocks</h2>
                <p><span data-i18n="header.subtitle">Sistema de consulta de inventario en tiempo real</span></p>
            </div>
            <div class="sidebar-developer">
                <span>Powered by</span>
                <img src="assets/logojobers.png" alt="Jobers" class="developer-logo">
            </div>
        </div>

        <div class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <img id="mobile-logo" src="assets/logojobers.png" alt="Logo" class="mobile-logo">
                    <h1 data-i18n="auth.loginTitle">Iniciar Sesi√≥n</h1>
                    <p class="login-subtitle" data-i18n="auth.loginSubtitle">Accede a tu cuenta para continuar</p>
                </div>

                <div id="alert-container"></div>

                <form class="login-form" id="login-form" method="POST" action="#">
                    <div class="form-group">
                        <label for="username" data-i18n="auth.username">Usuario</label>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            data-i18n-placeholder="authPlaceholders.username"
                            placeholder="Ingresa tu usuario"
                            required
                            autocomplete="username"
                        >
                    </div>

                    <div class="form-group">
                        <label for="password" data-i18n="auth.password">Contrase√±a</label>
                        <div class="password-wrapper">
                            <input
                                type="password"
                                id="password"
                                name="password"
                                data-i18n-placeholder="authPlaceholders.password"
                                placeholder="Ingresa tu contrase√±a"
                                required
                                autocomplete="current-password"
                            >
                            <button type="button" class="password-toggle" onclick="togglePassword('password', this)" aria-label="Mostrar contrase√±a">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn-login" id="btn-login" data-i18n="auth.loginButton">
                        Iniciar Sesi√≥n
                    </button>
                </form>

                <div id="register-link-container" class="login-link" style="display: none;">
                    <span data-i18n="auth.noAccount">¬øNo tienes cuenta?</span> <a href="/register" data-i18n="auth.createAccount">Crear cuenta</a>
                </div>

                <div id="resend-link-container" class="login-link" style="display: none; margin-top: 10px;">
                    <a href="#" onclick="mostrarFormularioReenvio(event)" data-i18n="auth.resendVerification">¬øNo recibiste el email de verificaci√≥n?</a>
                </div>

                <!-- Formulario para reenviar verificaci√≥n (oculto por defecto) -->
                <div id="resend-form" class="resend-form-container" style="display: none;">
                    <h3 data-i18n="auth.resendVerificationTitle">Reenviar email de verificaci√≥n</h3>
                    <div class="form-group">
                        <input type="email" id="resend-email" placeholder="tu@email.com" data-i18n-placeholder="authPlaceholders.email" required>
                    </div>
                    <button type="button" class="btn-login" onclick="reenviarVerificacion()" id="btn-resend" data-i18n="auth.resendButton">
                        Reenviar
                    </button>
                    <button type="button" class="btn-secondary" onclick="ocultarFormularioReenvio()" style="margin-left: 10px;" data-i18n="common.cancel">
                        Cancelar
                    </button>
                    <div id="resend-alert" style="margin-top: 15px;"></div>
                </div>

                <!-- Controles y logo desarrollador en m√≥vil (sidebar oculto) -->
                <div class="login-mobile-footer">
                    <div class="login-mobile-controls">
                        <div class="theme-toggle-login">
                            <span class="theme-icon" id="theme-icon-mobile" onclick="toggleTheme()">‚òÄÔ∏è</span>
                            <label class="switch">
                                <input type="checkbox" id="theme-switch-mobile" checked onchange="toggleTheme()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <select id="lang-selector-mobile" class="lang-selector" onchange="I18n.setLanguage(this.value)">
                            <option value="es">ES</option>
                            <option value="en">EN</option>
                            <option value="fr">FR</option>
                        </select>
                        <span class="version-indicator-inline" id="version-indicator-mobile" onclick="openChangelogModal()" title="Ver historial de cambios"></span>
                    </div>
                    <div class="mobile-developer" id="mobile-developer">
                        <span>Powered by</span>
                        <img src="assets/logojobers.png" alt="Jobers" class="developer-logo">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de versi√≥n (clicable para ver changelog) -->
    <div class="version-indicator" id="version-indicator" onclick="openChangelogModal()" title="Ver historial de cambios"></div>

    <!-- Modal de Changelog -->
    <div id="changelog-modal" class="changelog-modal" style="display: none;">
        <div class="changelog-modal-overlay" onclick="closeChangelogModal()"></div>
        <div class="changelog-modal-content">
            <div class="changelog-modal-header">
                <h2>üìã Historial de Cambios</h2>
                <button class="changelog-modal-close" onclick="closeChangelogModal()">&times;</button>
            </div>
            <div class="changelog-modal-body" id="changelog-content">
                <!-- Contenido cargado din√°micamente -->
            </div>
            <div class="changelog-modal-footer">
                <button class="btn-changelog-close" onclick="closeChangelogModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de cambio de contrase√±a obligatorio -->
    <div id="change-password-modal" class="password-modal" style="display: none;">
        <div class="password-modal-overlay"></div>
        <div class="password-modal-content">
            <div class="password-modal-header">
                <h2 data-i18n="changePassword.title">Cambiar Contrase√±a</h2>
            </div>
            <div class="password-modal-body">
                <p class="password-modal-subtitle" data-i18n="changePassword.subtitle">
                    Debes cambiar tu contrase√±a antes de continuar
                </p>
                <div id="password-alert-container"></div>
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="new-password" data-i18n="changePassword.newPassword">Nueva Contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="new-password" required autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('new-password', this)" aria-label="Mostrar contrase√±a">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password" data-i18n="changePassword.confirmPassword">Confirmar Nueva Contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirm-password" required autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('confirm-password', this)" aria-label="Mostrar contrase√±a">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn-login" id="btn-change-password" data-i18n="changePassword.changeButton">
                        Cambiar Contrase√±a
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js?v=20260120"></script>
    <script src="js/login.js?v=20260120"></script>
    <script>
        // Cargar versi√≥n desde API (desktop + mobile)
        fetch('/api/version')
            .then(r => r.json())
            .then(data => {
                document.getElementById('version-indicator').textContent = data.version;
                var mv = document.getElementById('version-indicator-mobile');
                if (mv) mv.textContent = data.version;
            })
            .catch(() => {
                document.getElementById('version-indicator').style.display = 'none';
            });

        // Sincronizar idioma en selector m√≥vil
        document.addEventListener('DOMContentLoaded', function() {
            var lang = localStorage.getItem('lang') || 'es';
            var s1 = document.getElementById('lang-selector');
            var s2 = document.getElementById('lang-selector-mobile');
            if (s1) s1.value = lang;
            if (s2) s2.value = lang;
        });

        // ==================== CHANGELOG ====================

        const changelogData = [
            {
                version: 'v1.22.17',
                date: '2026-02-07',
                title: 'Sidebar y pedidos m√≥vil',
                items: [
                    { type: 'improve', text: 'Bot√≥n "Cerrar Sesi√≥n" del sidebar fijo en la parte inferior' },
                    { type: 'fix', text: 'DataGrid no bloquea scroll en m√≥vil' },
                    { type: 'fix', text: 'Mis Pedidos: eliminada columna Cliente (no necesaria para usuario)' },
                    { type: 'fix', text: 'Filtro cliente con carga autom√°tica al seleccionar' }
                ]
            },
            {
                version: 'v1.22.13',
                date: '2026-02-07',
                title: 'Mapa a pantalla completa y ajustes m√≥vil',
                items: [
                    { type: 'improve', text: 'Mapa de ubicaci√≥n de clientes a pantalla completa con icono de cierre' },
                    { type: 'fix', text: 'Tarjetas de pedidos: nombres de cliente largos pasan a siguiente l√≠nea' },
                    { type: 'fix', text: 'DataGrid cards: valores largos se ajustan correctamente' }
                ]
            },
            {
                version: 'v1.22.12',
                date: '2026-02-07',
                title: 'Responsive m√≥vil y correcciones',
                items: [
                    { type: 'fix', text: 'Dashboard: tabla "Art√≠culos M√°s Vistos" pasa a tarjetas en m√≥vil' },
                    { type: 'fix', text: 'Tarjetas de pedidos y auditor√≠a ajustan textos largos correctamente' },
                    { type: 'fix', text: 'Buscador de clientes en pedidos ahora muestra sugerencias' },
                    { type: 'fix', text: 'Auditor√≠a: tokens largos en campo recurso se truncan' },
                    { type: 'improve', text: 'Mejor detalle de errores en mapa de clientes' }
                ]
            },
            {
                version: 'v1.22.0',
                date: '2026-02-07',
                title: 'Pedidos, DataGrid y paginaci√≥n',
                items: [
                    { type: 'new', text: 'P√°gina "Todos los Pedidos" con datos del ERP' },
                    { type: 'new', text: 'P√°gina "Mis Pedidos" para usuarios' },
                    { type: 'new', text: 'Componente DataGrid reutilizable (cabeceras fijas, footer, filtros)' },
                    { type: 'new', text: 'Paginaci√≥n en servidor para pedidos (rendimiento OVH)' },
                    { type: 'new', text: 'Mapa de ubicaci√≥n de clientes con OpenStreetMap' },
                    { type: 'new', text: 'Buscador autocompletado de clientes en filtros' },
                    { type: 'new', text: 'Detalle de dispositivo en auditor√≠a de LOGIN' },
                    { type: 'improve', text: 'M√≥dulos JS compartidos (page-common.js, data-grid.js, grid-filters.js)' },
                    { type: 'improve', text: 'Empaquetado junto a botones en detalle de stock' },
                    { type: 'fix', text: 'Bot√≥n cerrar (X) junto a acciones en detalle de stock' }
                ]
            },
            {
                version: 'v1.18.0',
                date: '2026-02-06',
                title: 'Changelog y mapeo por dominio',
                items: [
                    { type: 'new', text: 'Modal de changelog al hacer clic en versi√≥n' },
                    { type: 'new', text: 'Mapeo de dominios a conexiones en BD Central' },
                    { type: 'new', text: 'URLs sin par√°metro ?connection visible' },
                    { type: 'improve', text: 'Cada subdominio puede tener su propia conexi√≥n' }
                ]
            },
            {
                version: 'v1.17.7',
                date: '2026-02-05',
                title: 'Mejoras de login y propuestas',
                items: [
                    { type: 'new', text: 'Controles de tema e idioma en panel m√≥vil' },
                    { type: 'new', text: 'Logo "Powered by" en login m√≥vil' },
                    { type: 'new', text: 'Bot√≥n editar estado de propuestas (admin)' },
                    { type: 'fix', text: 'Fecha de sincronizaci√≥n visible en m√≥vil' },
                    { type: 'fix', text: 'Test SMTP para puerto 465 (SSL)' }
                ]
            },
            {
                version: 'v1.17.0',
                date: '2026-02-01',
                title: 'Modo espejo y sincronizaci√≥n',
                items: [
                    { type: 'new', text: 'Modo espejo con indicador en header' },
                    { type: 'new', text: 'Sincronizaci√≥n autom√°tica de tablas' },
                    { type: 'improve', text: 'Optimizaci√≥n de consultas con CHECKSUM' }
                ]
            },
            {
                version: 'v1.16.0',
                date: '2026-01-25',
                title: 'Paginaci√≥n y filtros avanzados',
                items: [
                    { type: 'new', text: 'Paginaci√≥n en backend para mejor rendimiento' },
                    { type: 'new', text: 'Filtros por columna estilo WorkWithPlus' },
                    { type: 'new', text: 'Ordenaci√≥n por columnas clicables' },
                    { type: 'improve', text: 'Grid avanzada en p√°ginas de administraci√≥n' }
                ]
            },
            {
                version: 'v1.15.0',
                date: '2026-01-20',
                title: 'Seguridad y auditor√≠a',
                items: [
                    { type: 'new', text: 'Sistema de auditor√≠a de usuarios' },
                    { type: 'new', text: 'Protecci√≥n CSRF en formularios' },
                    { type: 'new', text: 'Gesti√≥n de sesiones activas' },
                    { type: 'fix', text: 'Conexi√≥n cifrada SSL a SQL Server' }
                ]
            }
        ];

        function openChangelogModal() {
            const modal = document.getElementById('changelog-modal');
            const content = document.getElementById('changelog-content');

            content.innerHTML = changelogData.map(version => `
                <div class="changelog-version">
                    <div class="changelog-version-header">
                        <span class="changelog-version-tag">${version.version}</span>
                        <span class="changelog-version-date">${version.date}</span>
                    </div>
                    <div class="changelog-version-title">${version.title}</div>
                    <ul class="changelog-items">
                        ${version.items.map(item => `
                            <li>
                                <span class="changelog-badge changelog-badge-${item.type}">
                                    ${item.type === 'new' ? 'Nuevo' : item.type === 'fix' ? 'Fix' : 'Mejora'}
                                </span>
                                ${item.text}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');

            modal.style.display = 'flex';
        }

        function closeChangelogModal() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        // Cerrar con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeChangelogModal();
            }
        });
    </script>
</body>
</html>
