<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Gesti√≥n de Stocks</title>
    <script>
        // Inyectar colores del tema ANTES del CSS para evitar flash
        (function () {
            const themes = {
                'rubi': { primary: '#FF4338', primaryDark: '#D32F2F', primaryLight: '#FF6B6B' },
                'zafiro': { primary: '#2196F3', primaryDark: '#1565C0', primaryLight: '#64B5F6' },
                'esmeralda': { primary: '#4CAF50', primaryDark: '#2E7D32', primaryLight: '#81C784' },
                'amatista': { primary: '#9C27B0', primaryDark: '#6A1B9A', primaryLight: '#BA68C8' },
                'ambar': { primary: '#FF9800', primaryDark: '#E65100', primaryLight: '#FFB74D' },
                'grafito': { primary: '#607D8B', primaryDark: '#37474F', primaryLight: '#90A4AE' },
                'corporativo': { primary: '#1a365d', primaryDark: '#0d1b2a', primaryLight: '#2c5282' },
                'ejecutivo': { primary: '#2d3748', primaryDark: '#1a202c', primaryLight: '#4a5568' },
                'oceano': { primary: '#0077b6', primaryDark: '#023e8a', primaryLight: '#0096c7' },
                'bosque': { primary: '#2d6a4f', primaryDark: '#1b4332', primaryLight: '#40916c' },
                'vino': { primary: '#722f37', primaryDark: '#4a1c23', primaryLight: '#a4343a' },
                'medianoche': { primary: '#1e3a5f', primaryDark: '#0d1b2a', primaryLight: '#2e5077' },
                'titanio': { primary: '#4a5568', primaryDark: '#2d3748', primaryLight: '#718096' },
                'bronce': { primary: '#8b5a2b', primaryDark: '#5c3d1e', primaryLight: '#a0522d' },
                'elegante': { primary: '#FF4438', primaryDark: '#1a1a1a', primaryLight: '#FF6B5B' }
            };
            const theme = localStorage.getItem('theme') || 'dark';
            const colorTheme = localStorage.getItem('colorTheme') || 'rubi';
            const colors = themes[colorTheme] || themes['rubi'];

            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-color-theme', colorTheme);

            // Inyectar colores como CSS inline con !important para ganar especificidad
            const style = document.createElement('style');
            style.id = 'theme-colors-inline';
            style.textContent = ':root{--primary:' + colors.primary + '!important;--primary-dark:' + colors.primaryDark + '!important;--primary-light:' + colors.primaryLight + '!important}';
            document.head.appendChild(style);

            // Favicon desde cache
            var _faviconUrl = localStorage.getItem('faviconUrl');
            if (_faviconUrl) {
                var link = document.createElement('link');
                link.rel = 'icon';
                link.href = _faviconUrl;
                document.head.appendChild(link);
            }

            // Pre-cargar logo del cliente desde cache para evitar flash
            var _logoUrl = localStorage.getItem('logoUrl');
            if (_logoUrl) {
                document.addEventListener('DOMContentLoaded', function() {
                    var sLogo = document.getElementById('sidebar-logo');
                    var mLogo = document.getElementById('mobile-logo');
                    if (sLogo) { sLogo.src = _logoUrl; sLogo.style.visibility = 'visible'; }
                    if (mLogo) { mLogo.src = _logoUrl; mLogo.style.visibility = 'visible'; }
                });
            }
        })();
    </script>
    <link rel="stylesheet" href="css/styles.css?v=1.26.0">
</head>
<body>
    <!-- Selector de idioma y tema fijo -->
    <div class="login-top-controls">
        <div class="theme-toggle-login">
            <span class="theme-icon" id="theme-icon" onclick="toggleTheme()">‚òÄÔ∏è</span>
            <label class="switch">
                <input type="checkbox" id="theme-switch" checked onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
        <select id="lang-selector" class="lang-selector" onchange="I18n.setLanguage(this.value)">
            <option value="es">ES</option>
            <option value="en">EN</option>
            <option value="fr">FR</option>
        </select>
    </div>

    <div class="login-wrapper">
        <div class="login-sidebar">
            <div class="sidebar-content">
                <img id="sidebar-logo" src="" alt="Logo" class="sidebar-logo" style="visibility:hidden">
                <h2 data-i18n="header.title">Gesti√≥n de Stocks</h2>
                <p><span data-i18n="header.subtitle">Sistema de consulta de inventario en tiempo real</span></p>
            </div>
            <div class="sidebar-developer" onclick="openCopyrightModal()" style="cursor: pointer;" title="Propiedad intelectual">
                <span>Powered by</span>
                <img src="assets/logojobers.png" alt="Jobers" class="developer-logo">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.5;margin-left:2px"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </div>
        </div>

        <div class="login-container">
            <div class="login-box">
                <div class="login-header">
                    <img id="mobile-logo" src="" alt="Logo" class="mobile-logo" style="visibility:hidden">
                    <h1 data-i18n="auth.loginTitle">Iniciar Sesi√≥n</h1>
                    <p class="login-subtitle" data-i18n="auth.loginSubtitle">Accede a tu cuenta para continuar</p>
                </div>

                <div id="alert-container"></div>

                <form class="login-form" id="login-form" method="POST" action="#">
                    <div class="form-group">
                        <label for="username" data-i18n="auth.username">Usuario</label>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            data-i18n-placeholder="authPlaceholders.username"
                            placeholder="Ingresa tu usuario"
                            required
                            autocomplete="username"
                        >
                    </div>

                    <div class="form-group">
                        <label for="password" data-i18n="auth.password">Contrase√±a</label>
                        <div class="password-wrapper">
                            <input
                                type="password"
                                id="password"
                                name="password"
                                data-i18n-placeholder="authPlaceholders.password"
                                placeholder="Ingresa tu contrase√±a"
                                required
                                autocomplete="current-password"
                            >
                            <button type="button" class="password-toggle" onclick="togglePassword('password', this)" aria-label="Mostrar contrase√±a">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn-login" id="btn-login" data-i18n="auth.loginButton">
                        Iniciar Sesi√≥n
                    </button>
                </form>

                <div id="register-link-container" class="login-link" style="display: none;">
                    <span data-i18n="auth.noAccount">¬øNo tienes cuenta?</span> <a href="/register" data-i18n="auth.createAccount">Crear cuenta</a>
                </div>

                <div id="forgot-password-container" class="login-link" style="margin-top: 10px;">
                    <a href="#" onclick="mostrarFormularioRecuperacion(event)" data-i18n="auth.forgotPassword">¬øNo recuerdas tu contrase√±a?</a>
                </div>

                <div id="resend-link-container" class="login-link" style="display: none; margin-top: 10px;">
                    <a href="#" onclick="mostrarFormularioReenvio(event)" data-i18n="auth.resendVerification">¬øNo recibiste el email de verificaci√≥n?</a>
                </div>

                <!-- Formulario para recuperar contrase√±a (oculto por defecto) -->
                <div id="forgot-password-form" class="resend-form-container" style="display: none;">
                    <h3 data-i18n="auth.forgotPasswordTitle">Recuperar contrase√±a</h3>
                    <p class="login-subtitle" style="margin-bottom: 15px;" data-i18n="auth.forgotPasswordSubtitle">Introduce tu email para recibir instrucciones</p>
                    <div class="form-group">
                        <input type="email" id="forgot-email" placeholder="tu@email.com" data-i18n-placeholder="authPlaceholders.email" required>
                    </div>
                    <button type="button" class="btn-login" onclick="enviarRecuperacion()" id="btn-forgot" data-i18n="auth.forgotPasswordButton">
                        Enviar instrucciones
                    </button>
                    <button type="button" class="btn-secondary" onclick="ocultarFormularioRecuperacion()" style="margin-left: 10px;" data-i18n="common.cancel">
                        Cancelar
                    </button>
                    <div id="forgot-alert" style="margin-top: 15px;"></div>
                </div>

                <!-- Formulario para reenviar verificaci√≥n (oculto por defecto) -->
                <div id="resend-form" class="resend-form-container" style="display: none;">
                    <h3 data-i18n="auth.resendVerificationTitle">Reenviar email de verificaci√≥n</h3>
                    <div class="form-group">
                        <input type="email" id="resend-email" placeholder="tu@email.com" data-i18n-placeholder="authPlaceholders.email" required>
                    </div>
                    <button type="button" class="btn-login" onclick="reenviarVerificacion()" id="btn-resend" data-i18n="auth.resendButton">
                        Reenviar
                    </button>
                    <button type="button" class="btn-secondary" onclick="ocultarFormularioReenvio()" style="margin-left: 10px;" data-i18n="common.cancel">
                        Cancelar
                    </button>
                    <div id="resend-alert" style="margin-top: 15px;"></div>
                </div>

                <!-- Controles y logo desarrollador en m√≥vil (sidebar oculto) -->
                <div class="login-mobile-footer">
                    <div class="login-mobile-controls">
                        <div class="theme-toggle-login">
                            <span class="theme-icon" id="theme-icon-mobile" onclick="toggleTheme()">‚òÄÔ∏è</span>
                            <label class="switch">
                                <input type="checkbox" id="theme-switch-mobile" checked onchange="toggleTheme()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <select id="lang-selector-mobile" class="lang-selector" onchange="I18n.setLanguage(this.value)">
                            <option value="es">ES</option>
                            <option value="en">EN</option>
                            <option value="fr">FR</option>
                        </select>
                        <span class="version-indicator-inline" id="version-indicator-mobile" onclick="openChangelogModal()" title="Ver historial de cambios"></span>
                    </div>
                    <div class="mobile-developer" id="mobile-developer" onclick="openCopyrightModal()" style="cursor: pointer;" title="Propiedad intelectual">
                        <span>Powered by</span>
                        <img src="assets/logojobers.png" alt="Jobers" class="developer-logo">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.5;margin-left:2px"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de versi√≥n (clicable para ver changelog) -->
    <div class="version-indicator" id="version-indicator" onclick="openChangelogModal()" title="Ver historial de cambios"></div>

    <!-- Modal de Propiedad Intelectual -->
    <div id="copyright-modal" class="changelog-modal" style="display: none;">
        <div class="changelog-modal-overlay" onclick="closeCopyrightModal()"></div>
        <div class="changelog-modal-content" style="max-width: 520px;">
            <div class="changelog-modal-header">
                <h2>Propiedad Intelectual</h2>
                <button class="changelog-modal-close" onclick="closeCopyrightModal()">&times;</button>
            </div>
            <div class="changelog-modal-body" style="padding: 24px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="assets/logojobers.png" alt="Jobers" style="max-width: 140px; margin-bottom: 12px;">
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem;">Jobers y Asociados S.L.</h3>
                    <p style="margin: 0; opacity: 0.6; font-size: 0.85rem;">Derechos reservados</p>
                </div>
                <div class="ip-sections" style="display: flex; flex-direction: column; gap: 14px; font-size: 0.85rem; line-height: 1.6;">
                    <div style="padding: 12px 14px; border-radius: 8px; background: var(--bg-secondary, #f5f5f5); border-left: 3px solid var(--primary, #FF4338);">
                        <strong style="display: block; margin-bottom: 4px;">Titularidad</strong>
                        Este software, incluyendo pero no limitado a su codigo fuente, diseno, interfaces de usuario, documentacion, bases de datos y todos los materiales relacionados, es propiedad exclusiva de <strong>Jobers y Asociados S.L.</strong>
                    </div>
                    <div style="padding: 12px 14px; border-radius: 8px; background: var(--bg-secondary, #f5f5f5); border-left: 3px solid var(--primary, #FF4338);">
                        <strong style="display: block; margin-bottom: 4px;">Derechos de Autor</strong>
                        Todos los derechos de propiedad intelectual e industrial sobre esta aplicacion estan protegidos por las leyes espanolas de propiedad intelectual y los tratados internacionales aplicables.
                        <div style="margin-top: 8px; padding: 8px 10px; border-radius: 6px; background: rgba(229, 62, 62, 0.08); font-size: 0.82rem;">
                            Queda prohibida la reproduccion, distribucion, comunicacion publica, transformacion o cualquier otra forma de explotacion de este software sin autorizacion expresa y por escrito del titular.
                        </div>
                    </div>
                    <div style="padding: 12px 14px; border-radius: 8px; background: var(--bg-secondary, #f5f5f5); border-left: 3px solid var(--primary, #FF4338);">
                        <strong style="display: block; margin-bottom: 4px;">Licencia de Uso</strong>
                        El acceso a esta aplicacion se concede unicamente bajo licencia de uso limitada, personal e intransferible. Esta licencia no implica en ningun caso la cesion de derechos de propiedad intelectual sobre el software.
                    </div>
                    <div style="padding: 12px 14px; border-radius: 8px; background: var(--bg-secondary, #f5f5f5); border-left: 3px solid var(--primary, #FF4338);">
                        <strong style="display: block; margin-bottom: 4px;">Restricciones</strong>
                        El usuario se compromete a no realizar ingenieria inversa, descompilar, desensamblar ni intentar derivar el codigo fuente de la aplicacion. Cualquier uso no autorizado constituira una infraccion de los derechos del titular y podra dar lugar a las acciones legales correspondientes.
                    </div>
                    <div style="padding: 12px 14px; border-radius: 8px; background: var(--bg-secondary, #f5f5f5); border-left: 3px solid var(--primary, #FF4338);">
                        <strong style="display: block; margin-bottom: 4px;">Contacto</strong>
                        Para consultas relacionadas con licencias o permisos de uso, contacte con <strong>Jobers y Asociados S.L.</strong>
                    </div>
                </div>
                <p style="text-align: center; margin: 16px 0 0 0; font-size: 0.8rem; opacity: 0.5;">&copy; 2025-2026 Jobers y Asociados S.L. &middot; CIF: B46917142</p>
            </div>
        </div>
    </div>

    <!-- Modal de Changelog -->
    <div id="changelog-modal" class="changelog-modal" style="display: none;">
        <div class="changelog-modal-overlay" onclick="closeChangelogModal()"></div>
        <div class="changelog-modal-content">
            <div class="changelog-modal-header">
                <h2>üìã Historial de Cambios</h2>
                <button class="changelog-modal-close" onclick="closeChangelogModal()">&times;</button>
            </div>
            <div class="changelog-modal-body" id="changelog-content">
                <!-- Contenido cargado din√°micamente -->
            </div>
            <div class="changelog-modal-footer">
                <button class="btn-changelog-close" onclick="closeChangelogModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de cambio de contrase√±a obligatorio -->
    <div id="change-password-modal" class="password-modal" style="display: none;">
        <div class="password-modal-overlay"></div>
        <div class="password-modal-content">
            <div class="password-modal-header">
                <h2 data-i18n="changePassword.title">Cambiar Contrase√±a</h2>
            </div>
            <div class="password-modal-body">
                <p class="password-modal-subtitle" data-i18n="changePassword.subtitle">
                    Debes cambiar tu contrase√±a antes de continuar
                </p>
                <div id="password-alert-container"></div>
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="new-password" data-i18n="changePassword.newPassword">Nueva Contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="new-password" required autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('new-password', this)" aria-label="Mostrar contrase√±a">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password" data-i18n="changePassword.confirmPassword">Confirmar Nueva Contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirm-password" required autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('confirm-password', this)" aria-label="Mostrar contrase√±a">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn-login" id="btn-change-password" data-i18n="changePassword.changeButton">
                        Cambiar Contrase√±a
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js?v=20260120"></script>
    <script src="js/login.js?v=20260120"></script>
    <script>
        // Cargar versi√≥n desde API (desktop + mobile)
        fetch('/api/version')
            .then(r => r.json())
            .then(data => {
                document.getElementById('version-indicator').textContent = data.version;
                var mv = document.getElementById('version-indicator-mobile');
                if (mv) mv.textContent = data.version;
            })
            .catch(() => {
                document.getElementById('version-indicator').style.display = 'none';
            });

        // Sincronizar idioma en selector m√≥vil
        document.addEventListener('DOMContentLoaded', function() {
            var lang = localStorage.getItem('lang') || 'es';
            var s1 = document.getElementById('lang-selector');
            var s2 = document.getElementById('lang-selector-mobile');
            if (s1) s1.value = lang;
            if (s2) s2.value = lang;
        });

        // ==================== CHANGELOG ====================

        const changelogData = [
            { version: 'v1.33.2', date: '2026-02-24', title: 'Menu de acciones en usuarios', items: [
                {type: 'improve', text: 'Menu desplegable de tres puntos en acciones de usuarios (reemplaza multiples botones)'},
                {type: 'new', text: 'Checkbox "Ver precios" en modal de edicion de usuario'},
                {type: 'improve', text: 'Eliminada columna separada de precios en tabla de usuarios'}
            ]},
            { version: 'v1.33.1', date: '2026-02-24', title: 'Control de precios por usuario', items: [
                {type: 'new', text: 'Control individual de visibilidad de precios por usuario desde gestion de usuarios'},
                {type: 'new', text: 'Boton toggle ojo/ojo-tachado en acciones de usuario para activar/desactivar precios'},
                {type: 'new', text: 'Columna "Ver precios" en tabla de usuarios (solo visible si el parametro global esta activo)'},
                {type: 'improve', text: 'Para ver precios, tanto el parametro global de empresa como el flag del usuario deben estar activos'}
            ]},
            { version: 'v1.33.0', date: '2026-02-23', title: 'Precios de articulos en grid y detalle', items: [
                {type: 'new', text: 'Columna de precio en tabla de stocks (configurable por empresa con parametro MOSTRAR_PRECIOS)'},
                {type: 'new', text: 'Precio visible en detalle del producto, tarjetas movil y vista con imagenes'},
                {type: 'new', text: 'Formato EUR con separador de miles (1.234,56 ‚Ç¨)'},
                {type: 'improve', text: 'Vista que consulta precios por formato+calidad desde tabla manual (view_externos_articulos_precios)'}
            ]},
            { version: 'v1.32.0', date: '2026-02-21', title: 'Notificaciones, bloqueo de cuenta y limpieza de codigo', items: [
                {type: 'new', text: 'Sistema de notificaciones con actualizacion cada 30 segundos'},
                {type: 'new', text: 'Icono de campana en header con contador de notificaciones'},
                {type: 'new', text: 'Toast visual al recibir nuevas notificaciones'},
                {type: 'new', text: 'Bloqueo automatico de cuenta tras 5 intentos fallidos de login (15 min)'},
                {type: 'new', text: 'Indicador de intentos restantes al fallar login'},
                {type: 'new', text: 'Boton de desbloqueo manual de cuentas para administradores'},
                {type: 'improve', text: 'Migradas paginas admin a usar page-common.js (menos codigo duplicado)'}
            ]},
            { version: 'v1.31.2', date: '2026-02-20', title: 'Auto-vinculacion cliente en registro', items: [
                {type: 'new', text: 'Al registrarse, el sistema intenta vincular automaticamente al usuario con un cliente del ERP (por CIF/NIF, dominio email o nombre de empresa)'},
                {type: 'improve', text: 'Si se encuentra exactamente 1 coincidencia, se asigna el cliente_id automaticamente sin intervencion del admin'},
                {type: 'improve', text: 'La vinculacion es best-effort: si falla o hay ambiguedad, el registro continua normalmente'}
            ]},
            { version: 'v1.31.1', date: '2026-02-19', title: 'Fix busqueda por voz', items: [
                {type: 'fix', text: 'Busqueda por voz ahora envia siempre el texto reconocido como descripcion (antes podia quedar vacio)'},
                {type: 'fix', text: 'Matching de selects (serie, color) mas estricto: exact > startsWith > includes con longitud minima'},
                {type: 'fix', text: 'Quitado "A" de stop words para no eliminar codigos de calidad como "CALIDAD A"'},
                {type: 'fix', text: 'Codigos cortos como PZ o 1A ya no se filtran (minimo 2 chars en vez de 3)'}
            ]},
            { version: 'v1.31.0', date: '2026-02-18', title: 'Mis Consultas y fix filtros movil', items: [
                {type: 'new', text: 'Nueva pagina Mis Consultas donde cada usuario ve el estado de sus consultas sobre productos'},
                {type: 'new', text: 'Menu lateral con enlace a Mis Consultas disponible para todos los usuarios'},
                {type: 'new', text: 'Detalle de consulta con info del producto, mensaje enviado y respuesta del administrador'},
                {type: 'fix', text: 'Filtros de pedidos en vista movil ahora se apilan correctamente en una columna'}
            ]},
            { version: 'v1.30.3', date: '2026-02-17', title: 'Geolocalizacion por IP en Auditoria', items: [
                {type: 'new', text: 'Nueva columna Ubicacion en auditoria que muestra ciudad y pais con bandera'},
                {type: 'new', text: 'Al pinchar en la ubicacion se abre el mapa con la posicion del usuario'},
                {type: 'new', text: 'Modal de detalle ampliado con bloques de Ubicacion, Dispositivo y Otros detalles'},
                {type: 'improve', text: 'Login, login fallido y logout ahora registran la ubicacion geografica via IP'},
                {type: 'improve', text: 'Boton de detalle visible en cualquier evento con ubicacion o dispositivo'}
            ]},
            { version: 'v1.30.2', date: '2026-02-17', title: 'Mejoras Vista Almac√©n 3D', items: [
                {type: 'fix', text: 'Eliminado scroll del navegador al hacer zoom con rueda del rat√≥n en el canvas 3D'},
                {type: 'fix', text: 'Bot√≥n Vista Inicial ahora cancela animaciones en curso y vuelve correctamente'},
                {type: 'fix', text: 'Seleccionar zona en dropdown ahora encuadra correctamente toda la zona'},
                {type: 'new', text: 'Al seleccionar zona las celdas se resaltan y el resto se aten√∫a'},
                {type: 'improve', text: 'Vista Inicial y cambio de zona con animaci√≥n suave'},
                {type: 'fix', text: 'Teclas de direcci√≥n ya no provocan scroll de la p√°gina'}
            ]},
            { version: 'v1.30.1', date: '2026-02-16', title: 'Auditoria homogeneizada y email navegable', items: [
                {type: 'fix', text: 'Campo usuario en auditoria siempre muestra username (antes a veces mostraba email)'},
                {type: 'new', text: 'Nueva columna Email en auditoria con enlace directo al mantenimiento de usuarios'},
                {type: 'improve', text: 'Filtro de usuario en auditoria busca tanto por username como por email'}
            ]},
            { version: 'v1.30.0', date: '2026-02-16', title: 'Fix titulo modal detalle en temas de color', items: [
                {type: 'fix', text: 'Titulo del modal de detalle ahora siempre blanco sobre fondo con gradiente del tema'},
                {type: 'fix', text: 'Boton cerrar del modal de detalle con estilo correcto sobre fondo con gradiente'}
            ]},
            { version: 'v1.29.9', date: '2026-02-16', title: 'Filtros de fecha mejorados en Pedidos', items: [
                {type: 'improve', text: 'A√±o, Desde y Hasta en una sola fila compacta (a√±o ocupa menos espacio)'},
                {type: 'new', text: 'Botones de rango rapido: Hoy, Esta semana, Este mes, Mes anterior, Este trimestre'},
                {type: 'fix', text: 'En Todos los Pedidos, el campo Pais ya no se monta sobre las fechas'}
            ]},
            { version: 'v1.29.8', date: '2026-02-16', title: 'Imagenes nitidas en grid con Pillow', items: [
                {type: 'improve', text: 'Grid con imagenes: thumbnails redimensionados a 400px con Pillow (antes pixelados a 60px)'},
                {type: 'new', text: 'Nuevo parametro quality (thumb/grid) en endpoint /api/stocks/thumbnails'},
                {type: 'improve', text: 'Tabla sin imagenes sigue usando thumbnails pequenos (rapido)'}
            ]},
            { version: 'v1.29.7', date: '2026-02-13', title: 'Fix M2/Piezas en informe almacen', items: [
                {type: 'fix', text: 'Fix desglose M2/Piezas mostraba 0: fallback a columna tipo_unidad'},
                {type: 'improve', text: 'Script SQL actualizado: tipo_unidad renombrado a unidad en vista'}
            ]},
            { version: 'v1.29.6', date: '2026-02-13', title: 'Desglose M2 y Piezas en almacen', items: [
                {type: 'new', text: 'Informe Almacen: KPIs separados para M2 (unidad=1) y Piezas (unidad=0)'},
                {type: 'new', text: 'Dashboard: tarjetas de Almacen M2 y Almacen Piezas en resumen general'},
                {type: 'fix', text: 'Fix ocupacion negativa por multiples articulos en misma ubicacion'}
            ]},
            { version: 'v1.29.5', date: '2026-02-13', title: 'Informe Almacen y fix 3D movil', items: [
                {type: 'new', text: 'Nueva pagina Informe Almacen con KPIs, graficos y tablas de ocupacion'},
                {type: 'fix', text: 'Fix modelo 3D se movia solo en dispositivos moviles'}
            ]},
            { version: 'v1.29.2', date: '2026-02-13', title: 'Navegacion 3D mejorada en Almacen', items: [
                {type: 'new', text: 'Modo Paseo: caminar en primera persona con WASD y arrastrar para mirar'},
                {type: 'new', text: 'Selector de zonas desplegable para saltar a cualquier zona'},
                {type: 'new', text: 'Doble clic en rack para hacer zoom directo'},
                {type: 'new', text: 'D-Pad de navegacion para moverse por el almacen'},
                {type: 'improve', text: 'Transicion animada suave al entrar en modo paseo'}
            ]},
            { version: 'v1.29.1', date: '2026-02-12', title: 'Vista Almacen 3D mejorada', items: [
                {type: 'improve', text: 'Mapa 3D completo del almacen con todos los huecos (vacios y ocupados)'},
                {type: 'new', text: 'Nuevo endpoint /api/almacen/mapa con vista view_externos_almubimapa'},
                {type: 'improve', text: 'Estanterias con wireframes, divisiones por nivel y celdas coloreadas'},
                {type: 'improve', text: 'Navegacion 3D mejorada: orbitar, zoom, pan, reset camara (tecla B)'},
                {type: 'improve', text: 'Celdas vacias visibles con transparencia para ver estructura completa'}
            ]},
            { version: 'v1.28.5', date: '2026-02-12', title: 'Grafico articulos mas vistos', items: [
                {type: 'new', text: 'Grafico de barras Chart.js en seccion Articulos Mas Vistos del Dashboard'},
                {type: 'improve', text: 'Barras de vistas y usuarios unicos con colores del tema activo'},
                {type: 'improve', text: 'Tooltip muestra descripcion completa del articulo al pasar el raton'}
            ]},
            { version: 'v1.28.4', date: '2026-02-10', title: 'Mejora busqueda por voz', items: [
                {type: 'improve', text: 'Matching parcial en selects de serie y color (includes en vez de exacto)'},
                {type: 'new', text: 'Texto no reconocido en selects se envia como descripcion libre al backend'},
                {type: 'new', text: 'Toast visual mostrando el texto reconocido por voz'}
            ]},
            { version: 'v1.28.3', date: '2026-02-10', title: 'API Keys y PowerBuilder', items: [
                {type: 'new', text: 'Pagina de gestion de API Keys en panel de configuracion'},
                {type: 'fix', text: 'Soporte multi-empresa en autenticacion por API Key (PowerBuilder)'},
                {type: 'improve', text: 'API Key almacena conexion de empresa automaticamente al crearla'}
            ]},
            {
                version: 'v1.28.2',
                date: '2026-02-10',
                title: 'Fix PowerBuilder API Key + multi-empresa',
                items: [
                    { type: 'fix', text: 'API Key: soporte para par√°metro connection en endpoints con autenticaci√≥n por API Key (multi-empresa)' },
                    { type: 'improve', text: 'PowerBuilder: actualizado cliente API REST con soporte de conexi√≥n din√°mica por empresa' }
                ]
            },
            {
                version: 'v1.28.1',
                date: '2026-02-10',
                title: 'Ficha t√©cnica por tono + B√∫squeda por voz',
                items: [
                    { type: 'new', text: 'Ficha t√©cnica por tono: si existe ficha espec√≠fica para empresa+art√≠culo+tono la usa, si no usa la gen√©rica' }
                ]
            },
            {
                version: 'v1.28.0',
                date: '2026-02-10',
                title: 'B√∫squeda por voz en Stocks',
                items: [
                    { type: 'new', text: 'B√∫squeda por voz: bot√≥n micr√≥fono para buscar productos hablando' },
                    { type: 'new', text: 'Parsing inteligente: extrae formato, serie, color y calidad del texto hablado' },
                    { type: 'new', text: 'Tooltip de ayuda con ejemplos de comandos de voz al pasar el rat√≥n' },
                    { type: 'improve', text: 'Controlado por par√°metro PERMITIR_BUSQUEDA_VOZ para activar/desactivar' }
                ]
            },
            {
                version: 'v1.27.4',
                date: '2026-02-10',
                title: 'Fix geolocalizaci√≥n y mejoras DataGrid',
                items: [
                    { type: 'fix', text: 'Geolocalizaci√≥n pedidos: corregido "Cliente no encontrado" (usaba connection en vez de empresa_id)' },
                    { type: 'fix', text: 'Botones de acci√≥n en grid ya no saltan a otra fila' },
                    { type: 'improve', text: 'Grid limitada al ancho de ventana con columnas redimensionables' },
                    { type: 'improve', text: 'Icono Excel distintivo en DataGrid' }
                ]
            },
            {
                version: 'v1.27.2',
                date: '2026-02-10',
                title: 'Mejoras DataGrid: icono Excel y mover columnas',
                items: [
                    { type: 'improve', text: 'Boton Excel en grid cambiado a icono (sin texto)' },
                    { type: 'new', text: 'Arrastrar y soltar cabeceras de columna para reordenar' },
                    { type: 'new', text: 'El orden de columnas se guarda en localStorage' }
                ]
            },
            {
                version: 'v1.27.1',
                date: '2026-02-10',
                title: 'Recuperar contrase√±a y mejoras registro',
                items: [
                    { type: 'new', text: 'Recuperar contrase√±a: enlace en login para restablecer por email' },
                    { type: 'new', text: 'Icono ojo para mostrar/ocultar contrase√±a en registro' },
                    { type: 'improve', text: 'Email de recuperaci√≥n con enlace de 1 hora de validez' }
                ]
            },
            {
                version: 'v1.27.0',
                date: '2026-02-09',
                title: 'Migraciones automaticas de BD',
                items: [
                    { type: 'new', text: 'Sistema de migraciones automaticas: la BD se actualiza sola al hacer login' },
                    { type: 'new', text: 'Tabla schema_migrations para control de versiones de esquema' },
                    { type: 'improve', text: 'Motor de migraciones reutilizable con validacion de seguridad (nunca hace DROP)' }
                ]
            },
            {
                version: 'v1.26.1',
                date: '2026-02-08',
                title: 'Importes pedidos con CAST',
                items: [
                    { type: 'fix', text: 'Importes de pedidos forzados a 2 decimales con CAST en SQL (en vez de ROUND)' }
                ]
            },
            {
                version: 'v1.26.0',
                date: '2026-02-08',
                title: 'Seguridad: Politica de contrase√±as y registro de IP',
                items: [
                    { type: 'new', text: 'Politica de contrase√±as: minimo 8 caracteres, mayuscula, minuscula, numero y caracter especial' },
                    { type: 'new', text: 'Indicador visual de requisitos de contrase√±a en tiempo real' },
                    { type: 'new', text: 'Expiracion periodica de contrase√±as (configurable, por defecto 90 dias)' },
                    { type: 'fix', text: 'Registro de IP real del cliente en auditoria (soporte proxies)' }
                ]
            },
            {
                version: 'v1.25.0',
                date: '2026-02-08',
                title: 'Exportar Excel y refactoring page-common',
                items: [
                    { type: 'new', text: 'Boton "Excel" en todas las grids para exportar datos filtrados a CSV' },
                    { type: 'improve', text: 'Dashboard, Email Config, Parametros y Logo Empresa migrados a page-common.js' },
                    { type: 'new', text: 'Campo "Referencia" (numpedcli) en pedidos' },
                    { type: 'improve', text: 'Importes formateados a 2 decimales con separador de miles' }
                ]
            },
            {
                version: 'v1.24.9',
                date: '2026-02-08',
                title: 'Referencia (Pedido Cliente) en pedidos',
                items: [
                    { type: 'new', text: 'Campo "Referencia" (numpedcli) visible en grid, tarjetas y detalle de pedidos' },
                    { type: 'improve', text: 'Totales de pedidos redondeados a 2 decimales en SQL' }
                ]
            },
            {
                version: 'v1.24.6',
                date: '2026-02-08',
                title: 'Formato importes y fix Express',
                items: [
                    { type: 'improve', text: 'Todos los importes con separador de miles y 2 decimales (formato es-ES)' },
                    { type: 'fix', text: 'C√°lculo de tama√±o BD para indicador Express usa sys.database_files (fiable)' },
                    { type: 'improve', text: 'Filtros de fecha en misma l√≠nea en m√≥vil (pedidos y propuestas)' }
                ]
            },
            {
                version: 'v1.24.4',
                date: '2026-02-08',
                title: 'Filtros m√≥vil y l√≠mite Express',
                items: [
                    { type: 'new', text: 'Indicador de espacio disponible en SQL Server Express (l√≠mite 10 GB) en Control BD' },
                    { type: 'improve', text: 'Filtros de fecha en propuestas en la misma l√≠nea en resoluci√≥n m√≥vil' },
                    { type: 'new', text: 'Tarjetas m√≥vil en la informaci√≥n de base de datos (Control BD)' }
                ]
            },
            {
                version: 'v1.24.3',
                date: '2026-02-08',
                title: 'Pa√≠s y provincia en grids de pedidos',
                items: [
                    { type: 'new', text: 'Columnas Pa√≠s y Provincia visibles en la grid de Todos los Pedidos y Mis Pedidos' },
                    { type: 'new', text: 'Pa√≠s y Provincia en tarjetas m√≥vil de pedidos' },
                    { type: 'improve', text: 'Filtros de pa√≠s/provincia muestran nombres en vez de c√≥digos' },
                    { type: 'improve', text: 'Formato de miles y 2 decimales en importes y pesos de pedidos' }
                ]
            },
            {
                version: 'v1.24.0',
                date: '2026-02-08',
                title: 'Existencias en detalle y Control de BD',
                items: [
                    { type: 'new', text: 'Badge de existencias con color en el modal de detalle de stock' },
                    { type: 'new', text: 'Nueva p√°gina Control BD en Configuraci√≥n con info del servidor SQL Server' }
                ]
            },
            {
                version: 'v1.23.2',
                date: '2026-02-08',
                title: 'Imagen/formato en detalle y filtros ubicaci√≥n',
                items: [
                    { type: 'new', text: 'Imagen thumbnail del art√≠culo en las l√≠neas del detalle de pedido' },
                    { type: 'new', text: 'Formato abreviado del art√≠culo visible en las l√≠neas del pedido' },
                    { type: 'new', text: 'Filtros de Pa√≠s y Provincia en p√°gina Todos los Pedidos' },
                    { type: 'improve', text: 'Cards m√≥vil de l√≠neas de pedido muestran imagen y formato' }
                ]
            },
            {
                version: 'v1.22.18',
                date: '2026-02-07',
                title: 'Fix paginaci√≥n y filtro cliente',
                items: [
                    { type: 'fix', text: 'Paginaci√≥n se ajusta a pantalla en m√≥vil (no desborda)' },
                    { type: 'fix', text: 'Filtro cliente usa match exacto (no muestra clientes similares)' },
                    { type: 'fix', text: 'Tarjetas de pedidos ajustadas al ancho correcto en m√≥vil' }
                ]
            },
            {
                version: 'v1.22.17',
                date: '2026-02-07',
                title: 'Sidebar y pedidos m√≥vil',
                items: [
                    { type: 'improve', text: 'Bot√≥n "Cerrar Sesi√≥n" del sidebar fijo en la parte inferior' },
                    { type: 'fix', text: 'DataGrid no bloquea scroll en m√≥vil' },
                    { type: 'fix', text: 'Mis Pedidos: eliminada columna Cliente (no necesaria para usuario)' },
                    { type: 'fix', text: 'Filtro cliente con carga autom√°tica al seleccionar' }
                ]
            },
            {
                version: 'v1.22.13',
                date: '2026-02-07',
                title: 'Mapa a pantalla completa y ajustes m√≥vil',
                items: [
                    { type: 'improve', text: 'Mapa de ubicaci√≥n de clientes a pantalla completa con icono de cierre' },
                    { type: 'fix', text: 'Tarjetas de pedidos: nombres de cliente largos pasan a siguiente l√≠nea' },
                    { type: 'fix', text: 'DataGrid cards: valores largos se ajustan correctamente' }
                ]
            },
            {
                version: 'v1.22.12',
                date: '2026-02-07',
                title: 'Responsive m√≥vil y correcciones',
                items: [
                    { type: 'fix', text: 'Dashboard: tabla "Art√≠culos M√°s Vistos" pasa a tarjetas en m√≥vil' },
                    { type: 'fix', text: 'Tarjetas de pedidos y auditor√≠a ajustan textos largos correctamente' },
                    { type: 'fix', text: 'Buscador de clientes en pedidos ahora muestra sugerencias' },
                    { type: 'fix', text: 'Auditor√≠a: tokens largos en campo recurso se truncan' },
                    { type: 'improve', text: 'Mejor detalle de errores en mapa de clientes' }
                ]
            },
            {
                version: 'v1.22.0',
                date: '2026-02-07',
                title: 'Pedidos, DataGrid y paginaci√≥n',
                items: [
                    { type: 'new', text: 'P√°gina "Todos los Pedidos" con datos del ERP' },
                    { type: 'new', text: 'P√°gina "Mis Pedidos" para usuarios' },
                    { type: 'new', text: 'Componente DataGrid reutilizable (cabeceras fijas, footer, filtros)' },
                    { type: 'new', text: 'Paginaci√≥n en servidor para pedidos (rendimiento OVH)' },
                    { type: 'new', text: 'Mapa de ubicaci√≥n de clientes con OpenStreetMap' },
                    { type: 'new', text: 'Buscador autocompletado de clientes en filtros' },
                    { type: 'new', text: 'Detalle de dispositivo en auditor√≠a de LOGIN' },
                    { type: 'improve', text: 'M√≥dulos JS compartidos (page-common.js, data-grid.js, grid-filters.js)' },
                    { type: 'improve', text: 'Empaquetado junto a botones en detalle de stock' },
                    { type: 'fix', text: 'Bot√≥n cerrar (X) junto a acciones en detalle de stock' }
                ]
            },
            {
                version: 'v1.18.0',
                date: '2026-02-06',
                title: 'Changelog y mapeo por dominio',
                items: [
                    { type: 'new', text: 'Modal de changelog al hacer clic en versi√≥n' },
                    { type: 'new', text: 'Mapeo de dominios a conexiones en BD Central' },
                    { type: 'new', text: 'URLs sin par√°metro ?connection visible' },
                    { type: 'improve', text: 'Cada subdominio puede tener su propia conexi√≥n' }
                ]
            },
            {
                version: 'v1.17.7',
                date: '2026-02-05',
                title: 'Mejoras de login y propuestas',
                items: [
                    { type: 'new', text: 'Controles de tema e idioma en panel m√≥vil' },
                    { type: 'new', text: 'Logo "Powered by" en login m√≥vil' },
                    { type: 'new', text: 'Bot√≥n editar estado de propuestas (admin)' },
                    { type: 'fix', text: 'Fecha de sincronizaci√≥n visible en m√≥vil' },
                    { type: 'fix', text: 'Test SMTP para puerto 465 (SSL)' }
                ]
            },
            {
                version: 'v1.17.0',
                date: '2026-02-01',
                title: 'Modo espejo y sincronizaci√≥n',
                items: [
                    { type: 'new', text: 'Modo espejo con indicador en header' },
                    { type: 'new', text: 'Sincronizaci√≥n autom√°tica de tablas' },
                    { type: 'improve', text: 'Optimizaci√≥n de consultas con CHECKSUM' }
                ]
            },
            {
                version: 'v1.16.0',
                date: '2026-01-25',
                title: 'Paginaci√≥n y filtros avanzados',
                items: [
                    { type: 'new', text: 'Paginaci√≥n en backend para mejor rendimiento' },
                    { type: 'new', text: 'Filtros por columna estilo WorkWithPlus' },
                    { type: 'new', text: 'Ordenaci√≥n por columnas clicables' },
                    { type: 'improve', text: 'Grid avanzada en p√°ginas de administraci√≥n' }
                ]
            },
            {
                version: 'v1.15.0',
                date: '2026-01-20',
                title: 'Seguridad y auditor√≠a',
                items: [
                    { type: 'new', text: 'Sistema de auditor√≠a de usuarios' },
                    { type: 'new', text: 'Protecci√≥n CSRF en formularios' },
                    { type: 'new', text: 'Gesti√≥n de sesiones activas' },
                    { type: 'fix', text: 'Conexi√≥n cifrada SSL a SQL Server' }
                ]
            }
        ];

        function openChangelogModal() {
            const modal = document.getElementById('changelog-modal');
            const content = document.getElementById('changelog-content');

            content.innerHTML = changelogData.map(version => `
                <div class="changelog-version">
                    <div class="changelog-version-header">
                        <span class="changelog-version-tag">${version.version}</span>
                        <span class="changelog-version-date">${version.date}</span>
                    </div>
                    <div class="changelog-version-title">${version.title}</div>
                    <ul class="changelog-items">
                        ${version.items.map(item => `
                            <li>
                                <span class="changelog-badge changelog-badge-${item.type}">
                                    ${item.type === 'new' ? 'Nuevo' : item.type === 'fix' ? 'Fix' : 'Mejora'}
                                </span>
                                ${item.text}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');

            modal.style.display = 'flex';
        }

        function closeChangelogModal() {
            document.getElementById('changelog-modal').style.display = 'none';
        }

        function openCopyrightModal() {
            document.getElementById('copyright-modal').style.display = 'flex';
        }

        function closeCopyrightModal() {
            document.getElementById('copyright-modal').style.display = 'none';
        }

        // Cerrar con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeChangelogModal();
                closeCopyrightModal();
            }
        });
    </script>
</body>
</html>
