<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todas las Propuestas - Administraci칩n</title>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Cargar tema guardado inmediatamente para evitar flash
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            const colorTheme = localStorage.getItem('colorTheme') || 'rubi';
            document.documentElement.setAttribute('data-color-theme', colorTheme);
            // Crear favicon desde localStorage (sin link est치tico para evitar flash)
            const faviconUrl = localStorage.getItem('faviconUrl');
            if (faviconUrl) {
                const link = document.createElement('link');
                link.rel = 'icon';
                link.href = faviconUrl;
                document.head.appendChild(link);
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header de la p치gina -->
        <div class="page-header">
            <div class="logo-section">
                <a href="#" onclick="goBack(); return false;" style="display: flex; align-items: center;">
                    <img src="" alt="Logo" class="logo" style="cursor: pointer; visibility: hidden;">
                </a>
                <h1 data-i18n="proposals.allTitle">Todas las Propuestas</h1>
            </div>
            <div class="header-actions">
                <div class="lang-selector-wrapper">
                    <select id="lang-selector" class="lang-selector lang-selector-header" onchange="I18n.setLanguage(this.value)">
                        <option value="es">ES</option>
                        <option value="en">EN</option>
                        <option value="fr">FR</option>
                    </select>
                </div>
                <button class="back-btn" onclick="goBack()">
                    <span data-i18n="proposals.backToStocks">Volver a Stocks</span>
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-container" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterStatus">Estado</label>
                    <select id="filter-estado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="" data-i18n="proposals.allStatuses">Todos los estados</option>
                        <option value="Enviada" data-i18n="proposals.statusSent">Enviada</option>
                        <option value="Procesada" data-i18n="proposals.statusProcessed">Procesada</option>
                        <option value="Cancelada" data-i18n="proposals.statusCancelled">Cancelada</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterDateFrom">Desde</label>
                    <input type="date" id="filter-fecha-desde" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterDateTo">Hasta</label>
                    <input type="date" id="filter-fecha-hasta" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="filter-actions" style="display: flex; gap: 10px;">
                    <button onclick="applyFilters()" class="btn-primary" style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" data-i18n="common.search">Buscar</button>
                    <button onclick="clearFilters()" class="btn-secondary" style="padding: 10px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" data-i18n="common.clear">Limpiar</button>
                </div>
            </div>
        </div>

        <!-- Contenedor principal de propuestas -->
        <div class="proposals-container">
            <div class="proposals-content">
                <!-- Loading state -->
                <div class="proposals-loading" id="proposals-loading">
                    <div class="spinner"></div>
                    <p data-i18n="proposals.loading">Cargando propuestas...</p>
                </div>

                <!-- Empty state -->
                <div class="proposals-empty" id="proposals-empty" style="display: none;">
                    <div class="proposals-empty-icon">游늶</div>
                    <h3 data-i18n="proposals.noProposals">No hay propuestas</h3>
                </div>

                <!-- Table view (desktop) -->
                <div class="proposals-table-wrapper" id="proposals-table-wrapper" style="display: none;">
                    <table class="proposals-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th data-i18n="proposals.user">Usuario</th>
                                <th data-i18n="proposals.date">Fecha</th>
                                <th data-i18n="proposals.items">Art칤culos</th>
                                <th data-i18n="proposals.status">Estado</th>
                                <th data-i18n="proposals.reference">Referencia</th>
                                <th data-i18n="users.actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="proposals-table-body">
                        </tbody>
                    </table>
                </div>

                <!-- Cards view (mobile) -->
                <div class="proposals-cards" id="proposals-cards">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalle de propuesta -->
    <div id="proposal-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="proposals.viewDetails">Ver Detalles</h2>
                <button class="modal-close" onclick="closeProposalModal()">칑</button>
            </div>
            <div class="proposal-detail-content" id="proposal-detail-content">
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js"></script>
    <script>
        // ==================== CONFIGURACI칍N ====================
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
        const API_URL = isLocalhost ? `${protocol}//${hostname}:5000` : `${protocol}//${hostname}`;

        // ==================== LOGO DIN츼MICO POR EMPRESA ====================
        function applyColorTheme(tema) {
            const validThemes = ['rubi', 'zafiro', 'esmeralda', 'amatista', 'ambar', 'grafito'];
            if (!validThemes.includes(tema)) tema = 'rubi';
            document.documentElement.setAttribute('data-color-theme', tema);
            localStorage.setItem('colorTheme', tema);
        }

        async function cargarLogoEmpresa() {
            const empresaId = localStorage.getItem('empresa_id') || '1';
            const logoElements = document.querySelectorAll('.logo');
            try {
                const configResponse = await fetch(`${API_URL}/api/empresa/${empresaId}/config`);
                const config = await configResponse.json();
                applyColorTheme(config.tema || 'rubi');
                const invertirFilter = config.invertir_logo ? 'brightness(0) invert(1)' : 'none';
                if (config.tiene_logo) {
                    const logoUrl = `${API_URL}/api/empresa/${empresaId}/logo?t=${Date.now()}`;
                    logoElements.forEach(el => {
                        el.src = logoUrl;
                        el.style.filter = invertirFilter;
                        el.style.visibility = 'visible';
                    });
                } else {
                    logoElements.forEach(el => {
                        el.src = 'assets/logo.svg';
                        el.style.filter = 'brightness(0) invert(1)';
                        el.style.visibility = 'visible';
                    });
                }
            } catch (error) {
                console.log('Error al cargar logo:', error);
                applyColorTheme('rubi');
                logoElements.forEach(el => {
                    el.src = 'assets/logo.svg';
                    el.style.filter = 'brightness(0) invert(1)';
                    el.style.visibility = 'visible';
                });
            }
        }

        let allProposals = [];
        let filteredProposals = [];

        // ==================== INICIALIZACI칍N ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar empresa_id
            const urlParams = new URLSearchParams(window.location.search);
            let empresaId = urlParams.get('empresa');

            if (empresaId) {
                localStorage.setItem('empresa_id', empresaId);
            } else {
                empresaId = localStorage.getItem('empresa_id');
            }

            if (!empresaId) {
                window.location.href = 'login.html';
                return;
            }

            // Cargar logo de empresa PRIMERO
            await cargarLogoEmpresa();

            // Inicializar i18n
            await I18n.init();

            // Actualizar selector de idioma
            const langSelector = document.getElementById('lang-selector');
            if (langSelector) {
                langSelector.value = I18n.currentLang;
            }

            // Verificar autenticaci칩n y permisos de admin
            await checkAuth();

            // Cargar propuestas
            await loadProposals();
        });

        // ==================== AUTENTICACI칍N ====================
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/api/current-user`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = await response.json();

                // Verificar que sea administrador o superusuario
                if (user.rol !== 'administrador' && user.rol !== 'superusuario') {
                    alert('No tienes permisos para acceder a esta p치gina');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = 'login.html';
            }
        }

        // ==================== CARGAR PROPUESTAS ====================
        async function loadProposals() {
            const loadingEl = document.getElementById('proposals-loading');
            const emptyEl = document.getElementById('proposals-empty');
            const tableWrapper = document.getElementById('proposals-table-wrapper');

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/propuestas?empresa=${empresaId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        alert('No tienes permisos para ver todas las propuestas');
                        window.location.href = 'index.html';
                        return;
                    }
                    throw new Error('Error loading proposals');
                }

                const data = await response.json();
                allProposals = data.propuestas || [];
                filteredProposals = [...allProposals];

                loadingEl.style.display = 'none';

                if (allProposals.length === 0) {
                    emptyEl.style.display = 'block';
                    tableWrapper.style.display = 'none';
                } else {
                    emptyEl.style.display = 'none';
                    tableWrapper.style.display = 'block';
                    renderProposals();
                }
            } catch (error) {
                console.error('Error loading proposals:', error);
                loadingEl.innerHTML = `<p style="color: #dc3545;">Error al cargar las propuestas</p>`;
            }
        }

        // ==================== FILTRAR PROPUESTAS ====================
        function applyFilters() {
            const estado = document.getElementById('filter-estado').value;
            const fechaDesde = document.getElementById('filter-fecha-desde').value;
            const fechaHasta = document.getElementById('filter-fecha-hasta').value;

            filteredProposals = allProposals.filter(proposal => {
                // Filtrar por estado
                if (estado && proposal.estado !== estado) {
                    return false;
                }

                // Filtrar por fecha desde
                if (fechaDesde) {
                    const proposalDate = new Date(proposal.fecha);
                    const filterDate = new Date(fechaDesde);
                    if (proposalDate < filterDate) {
                        return false;
                    }
                }

                // Filtrar por fecha hasta
                if (fechaHasta) {
                    const proposalDate = new Date(proposal.fecha);
                    const filterDate = new Date(fechaHasta);
                    filterDate.setHours(23, 59, 59, 999);  // Fin del d칤a
                    if (proposalDate > filterDate) {
                        return false;
                    }
                }

                return true;
            });

            renderProposals();
        }

        function clearFilters() {
            document.getElementById('filter-estado').value = '';
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';

            filteredProposals = [...allProposals];
            renderProposals();
        }

        // ==================== RENDERIZAR PROPUESTAS ====================
        function renderProposals() {
            const tableBody = document.getElementById('proposals-table-body');
            const cardsEl = document.getElementById('proposals-cards');
            const emptyEl = document.getElementById('proposals-empty');
            const tableWrapper = document.getElementById('proposals-table-wrapper');

            if (filteredProposals.length === 0) {
                emptyEl.style.display = 'block';
                tableWrapper.style.display = 'none';
                cardsEl.innerHTML = '';
                return;
            }

            emptyEl.style.display = 'none';
            tableWrapper.style.display = 'block';

            // Renderizar tabla
            tableBody.innerHTML = filteredProposals.map(proposal => `
                <tr>
                    <td><strong>#${proposal.id}</strong></td>
                    <td>
                        <span class="user-badge">
                            <span class="user-badge-icon">游녻</span>
                            ${proposal.username || 'Usuario'}
                        </span>
                    </td>
                    <td>${formatDate(proposal.fecha)}</td>
                    <td>${proposal.total_items} ${t('proposals.items').toLowerCase()}</td>
                    <td>${getStatusBadge(proposal.estado)}</td>
                    <td>${proposal.referencia || '-'}</td>
                    <td>
                        <div class="status-actions">
                            <button class="btn-view-details" onclick="viewProposalDetails(${proposal.id})">
                                ${t('proposals.viewDetails')}
                            </button>
                            <button class="btn-download-excel" onclick="downloadExcel(${proposal.id})" title="${t('proposals.downloadExcel')}">
                                游닌 Excel
                            </button>
                            ${proposal.estado === 'Enviada' ? `
                                <button class="btn-status btn-status-process" onclick="changeStatus(${proposal.id}, 'Procesada')">
                                    ${t('proposals.statusProcessed')}
                                </button>
                                <button class="btn-status btn-status-cancel" onclick="changeStatus(${proposal.id}, 'Cancelada')">
                                    ${t('proposals.statusCancelled')}
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            // Renderizar cards (m칩vil)
            cardsEl.innerHTML = filteredProposals.map(proposal => `
                <div class="proposal-card">
                    <div class="proposal-card-header">
                        <span class="proposal-card-id">#${proposal.id}</span>
                        ${getStatusBadge(proposal.estado)}
                    </div>
                    <div class="proposal-card-user">
                        <span class="user-badge">
                            <span class="user-badge-icon">游녻</span>
                            ${proposal.username || 'Usuario'}
                        </span>
                    </div>
                    <div class="proposal-card-date">${formatDate(proposal.fecha)}</div>
                    <div class="proposal-card-info">
                        <div class="proposal-card-info-item">
                            <label>${t('proposals.items')}</label>
                            <span>${proposal.total_items}</span>
                        </div>
                        ${proposal.referencia ? `
                        <div class="proposal-card-info-item">
                            <label>${t('proposals.reference')}</label>
                            <span>${proposal.referencia}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="proposal-card-actions">
                        <div class="action-buttons" style="width: 100%; justify-content: center;">
                            <button class="btn-view-details" onclick="viewProposalDetails(${proposal.id})">
                                ${t('proposals.viewDetails')}
                            </button>
                            <button class="btn-download-excel" onclick="downloadExcel(${proposal.id})" title="${t('proposals.downloadExcel')}">
                                游닌 Excel
                            </button>
                        </div>
                        ${proposal.estado === 'Enviada' ? `
                            <div class="status-actions" style="justify-content: center; margin-top: 8px;">
                                <button class="btn-status btn-status-process" onclick="changeStatus(${proposal.id}, 'Procesada')">
                                    ${t('proposals.statusProcessed')}
                                </button>
                                <button class="btn-status btn-status-cancel" onclick="changeStatus(${proposal.id}, 'Cancelada')">
                                    ${t('proposals.statusCancelled')}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ==================== DESCARGAR EXCEL ====================
        async function downloadExcel(proposalId) {
            try {
                const response = await fetch(`${API_URL}/api/propuestas/${proposalId}/excel`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error al descargar Excel');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `propuesta_${proposalId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Error downloading Excel:', error);
                alert(t('proposals.downloadExcelError'));
            }
        }

        // ==================== CAMBIAR ESTADO ====================
        async function changeStatus(proposalId, newStatus) {
            const statusText = newStatus === 'Procesada' ? t('proposals.statusProcessed') : t('proposals.statusCancelled');

            if (!confirm(`쮺ambiar el estado a "${statusText}"?`)) {
                return;
            }

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/propuestas/${proposalId}/estado?empresa=${empresaId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Error changing status');
                }

                // Actualizar la propuesta en la lista local
                const index = allProposals.findIndex(p => p.id === proposalId);
                if (index !== -1) {
                    allProposals[index].estado = newStatus;
                }

                // Actualizar en filteredProposals tambi칠n
                const filteredIndex = filteredProposals.findIndex(p => p.id === proposalId);
                if (filteredIndex !== -1) {
                    filteredProposals[filteredIndex].estado = newStatus;
                }

                renderProposals();
            } catch (error) {
                console.error('Error changing status:', error);
                alert('Error al cambiar el estado');
            }
        }

        // ==================== VER DETALLE DE PROPUESTA ====================
        async function viewProposalDetails(proposalId) {
            const modal = document.getElementById('proposal-detail-modal');
            const content = document.getElementById('proposal-detail-content');

            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="proposals-loading">
                    <div class="spinner"></div>
                    <p>${t('common.loading')}</p>
                </div>
            `;

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/propuestas/${proposalId}?empresa=${empresaId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error loading proposal details');
                }

                const data = await response.json();
                const proposal = data.propuesta;
                const lines = proposal.lineas || [];

                content.innerHTML = `
                    <div class="proposal-info">
                        <div class="proposal-info-item">
                            <label>ID</label>
                            <span>#${proposal.id}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.user')}</label>
                            <span>${proposal.username || 'Usuario'}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.date')}</label>
                            <span>${formatDate(proposal.fecha)}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.status')}</label>
                            <span>${getStatusBadge(proposal.estado)}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.items')}</label>
                            <span>${proposal.total_items}</span>
                        </div>
                        ${proposal.referencia ? `
                        <div class="proposal-info-item">
                            <label>${t('proposals.reference')}</label>
                            <span>${proposal.referencia}</span>
                        </div>
                        ` : ''}
                    </div>

                    ${proposal.comentarios ? `
                        <div class="proposal-comments">
                            <h4>${t('proposals.comments')}</h4>
                            <p>${proposal.comentarios}</p>
                        </div>
                    ` : ''}

                    <h3 class="proposal-lines-title">${t('proposals.items')}</h3>

                    <!-- Tabla para desktop -->
                    <table class="proposal-lines-table">
                        <thead>
                            <tr>
                                <th>${t('table.code')}</th>
                                <th>${t('table.description')}</th>
                                <th>${t('table.format')}</th>
                                <th>${t('table.quality')}</th>
                                <th>${t('table.tone')}</th>
                                <th>${t('table.caliber')}</th>
                                <th>${t('cart.requested')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lines.map(line => `
                                <tr>
                                    <td><strong>${line.codigo}</strong></td>
                                    <td>${line.descripcion}</td>
                                    <td>${line.formato}</td>
                                    <td>${line.calidad}</td>
                                    <td>${line.tono || '-'}</td>
                                    <td>${line.calibre || '-'}</td>
                                    <td><strong>${line.cantidad_solicitada} ${line.unidad}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <!-- Tarjetas para m칩vil -->
                    <div class="proposal-lines-cards">
                        ${lines.map(line => `
                            <div class="line-card">
                                <div class="line-card-header">
                                    <span class="line-card-code">${line.codigo}</span>
                                    <span class="line-card-qty">${line.cantidad_solicitada} ${line.unidad}</span>
                                </div>
                                <div class="line-card-desc">${line.descripcion}</div>
                                <div class="line-card-details">
                                    <div class="line-card-detail">
                                        <label>${t('table.format')}</label>
                                        <span>${line.formato}</span>
                                    </div>
                                    <div class="line-card-detail">
                                        <label>${t('table.quality')}</label>
                                        <span>${line.calidad}</span>
                                    </div>
                                    <div class="line-card-detail">
                                        <label>${t('table.tone')}</label>
                                        <span>${line.tono || '-'}</span>
                                    </div>
                                    <div class="line-card-detail">
                                        <label>${t('table.caliber')}</label>
                                        <span>${line.calibre || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading proposal details:', error);
                content.innerHTML = `<p style="color: #dc3545; text-align: center;">Error al cargar los detalles</p>`;
            }
        }

        // ==================== CERRAR MODAL ====================
        function closeProposalModal() {
            document.getElementById('proposal-detail-modal').style.display = 'none';
        }

        // ==================== UTILIDADES ====================
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusBadge(status) {
            const statusMap = {
                'Enviada': { class: 'status-enviada', key: 'proposals.statusSent' },
                'Procesada': { class: 'status-procesada', key: 'proposals.statusProcessed' },
                'Cancelada': { class: 'status-cancelada', key: 'proposals.statusCancelled' }
            };

            const statusInfo = statusMap[status] || { class: 'status-enviada', key: 'proposals.statusSent' };
            return `<span class="status-badge ${statusInfo.class}">${t(statusInfo.key)}</span>`;
        }

        function goBack() {
            const empresaId = localStorage.getItem('empresa_id');
            window.location.href = `index.html?empresa=${empresaId}`;
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('proposal-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProposalModal();
            }
        });

        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeProposalModal();
            }
        });
    </script>
</body>
</html>
