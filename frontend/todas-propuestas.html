<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todas las Propuestas - Administraci√≥n</title>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Cargar tema guardado inmediatamente para evitar flash
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            const colorTheme = localStorage.getItem('colorTheme') || 'rubi';
            document.documentElement.setAttribute('data-color-theme', colorTheme);
            // Crear favicon desde localStorage (sin link est√°tico para evitar flash)
            const faviconUrl = localStorage.getItem('faviconUrl');
            if (faviconUrl) {
                const link = document.createElement('link');
                link.rel = 'icon';
                link.href = faviconUrl;
                document.head.appendChild(link);
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header de la p√°gina -->
        <div class="page-header">
            <div class="logo-section">
                <a href="#" onclick="goBack(); return false;" style="display: flex; align-items: center;">
                    <img src="" alt="Logo" class="logo" style="cursor: pointer; visibility: hidden;">
                </a>
                <h1 data-i18n="proposals.allTitle">Todas las Propuestas</h1>
            </div>
            <div class="header-actions">
                <div class="lang-selector-wrapper">
                    <select id="lang-selector" class="lang-selector lang-selector-header" onchange="I18n.setLanguage(this.value)">
                        <option value="es">ES</option>
                        <option value="en">EN</option>
                        <option value="fr">FR</option>
                    </select>
                </div>
                <button class="back-btn" onclick="goBack()">
                    <span data-i18n="proposals.backToStocks">Volver a Stocks</span>
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-container" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterStatus">Estado</label>
                    <select id="filter-estado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="" data-i18n="proposals.allStatuses">Todos los estados</option>
                        <option value="Enviada" data-i18n="proposals.statusSent">Enviada</option>
                        <option value="Procesada" data-i18n="proposals.statusProcessed">Procesada</option>
                        <option value="Cancelada" data-i18n="proposals.statusCancelled">Cancelada</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterDateFrom">Desde</label>
                    <input type="date" id="filter-fecha-desde" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterDateTo">Hasta</label>
                    <input type="date" id="filter-fecha-hasta" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="filter-actions" style="display: flex; gap: 10px;">
                    <button onclick="applyFilters()" class="btn-primary" style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" data-i18n="common.search">Buscar</button>
                    <button onclick="clearFilters()" class="btn-secondary" style="padding: 10px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" data-i18n="common.clear">Limpiar</button>
                </div>
            </div>
        </div>

        <!-- Contenedor principal de propuestas -->
        <div class="proposals-container">
            <div class="proposals-content">
                <!-- Loading state -->
                <div class="proposals-loading" id="proposals-loading">
                    <div class="spinner"></div>
                    <p data-i18n="proposals.loading">Cargando propuestas...</p>
                </div>

                <!-- Empty state -->
                <div class="proposals-empty" id="proposals-empty" style="display: none;">
                    <div class="proposals-empty-icon">üìã</div>
                    <h3 data-i18n="proposals.noProposals">No hay propuestas</h3>
                </div>

                <!-- Chips de filtros activos -->
                <div class="column-filters-chips" id="column-filters-chips"></div>

                <!-- Table view (desktop) -->
                <div class="proposals-table-wrapper" id="proposals-table-wrapper" style="display: none;">
                    <table class="proposals-table" id="proposals-table">
                        <thead>
                            <tr>
                                <th data-column="id">
                                    <div class="column-header-wrapper">
                                        <span class="sortable-header" onclick="ordenarPor('id')">
                                            ID
                                            <svg class="sort-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor"><path d="M8 2l4 5H4l4-5zm0 12L4 9h8l-4 5z"/></svg>
                                        </span>
                                        <button class="column-filter-btn" onclick="abrirPopupFiltro('id', this)" title="Filtrar">
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 2h14l-5 6v5l-4 2v-7L1 2z"/></svg>
                                        </button>
                                    </div>
                                </th>
                                <th data-column="usuario" data-i18n="proposals.user">
                                    <div class="column-header-wrapper">
                                        <span class="sortable-header" onclick="ordenarPor('usuario')">
                                            Usuario
                                            <svg class="sort-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor"><path d="M8 2l4 5H4l4-5zm0 12L4 9h8l-4 5z"/></svg>
                                        </span>
                                        <button class="column-filter-btn" onclick="abrirPopupFiltro('usuario', this)" title="Filtrar">
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 2h14l-5 6v5l-4 2v-7L1 2z"/></svg>
                                        </button>
                                    </div>
                                </th>
                                <th data-column="fecha" data-i18n="proposals.date">
                                    <div class="column-header-wrapper">
                                        <span class="sortable-header" onclick="ordenarPor('fecha')">
                                            Fecha
                                            <svg class="sort-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor"><path d="M8 2l4 5H4l4-5zm0 12L4 9h8l-4 5z"/></svg>
                                        </span>
                                        <button class="column-filter-btn" onclick="abrirPopupFiltro('fecha', this)" title="Filtrar">
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 2h14l-5 6v5l-4 2v-7L1 2z"/></svg>
                                        </button>
                                    </div>
                                </th>
                                <th data-column="total_items" data-i18n="proposals.items">
                                    <div class="column-header-wrapper">
                                        <span class="sortable-header" onclick="ordenarPor('total_items')">
                                            Art√≠culos
                                            <svg class="sort-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor"><path d="M8 2l4 5H4l4-5zm0 12L4 9h8l-4 5z"/></svg>
                                        </span>
                                    </div>
                                </th>
                                <th data-column="estado" data-i18n="proposals.status">
                                    <div class="column-header-wrapper">
                                        <span class="sortable-header" onclick="ordenarPor('estado')">
                                            Estado
                                            <svg class="sort-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor"><path d="M8 2l4 5H4l4-5zm0 12L4 9h8l-4 5z"/></svg>
                                        </span>
                                        <button class="column-filter-btn" onclick="abrirPopupFiltro('estado', this)" title="Filtrar">
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 2h14l-5 6v5l-4 2v-7L1 2z"/></svg>
                                        </button>
                                    </div>
                                </th>
                                <th data-column="referencia" data-i18n="proposals.reference">
                                    <div class="column-header-wrapper">
                                        <span class="sortable-header" onclick="ordenarPor('referencia')">
                                            Referencia
                                            <svg class="sort-icon" viewBox="0 0 16 16" width="12" height="12" fill="currentColor"><path d="M8 2l4 5H4l4-5zm0 12L4 9h8l-4 5z"/></svg>
                                        </span>
                                        <button class="column-filter-btn" onclick="abrirPopupFiltro('referencia', this)" title="Filtrar">
                                            <svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 2h14l-5 6v5l-4 2v-7L1 2z"/></svg>
                                        </button>
                                    </div>
                                </th>
                                <th data-i18n="users.actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="proposals-table-body">
                        </tbody>
                    </table>
                </div>

                <!-- Cards view (mobile) -->
                <div class="proposals-cards" id="proposals-cards">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalle de propuesta -->
    <div id="proposal-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="proposals.viewDetails">Ver Detalles</h2>
                <button class="modal-close" onclick="closeProposalModal()">√ó</button>
            </div>
            <div class="proposal-detail-content" id="proposal-detail-content">
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js"></script>
    <script>
        // ==================== CONFIGURACI√ìN ====================
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
        const API_URL = isLocalhost ? `${protocol}//${hostname}:5000` : `${protocol}//${hostname}`;

        // ==================== LOGO DIN√ÅMICO POR EMPRESA ====================
        function applyColorTheme(tema) {
            const validThemes = ['rubi', 'zafiro', 'esmeralda', 'amatista', 'ambar', 'grafito'];
            if (!validThemes.includes(tema)) tema = 'rubi';
            document.documentElement.setAttribute('data-color-theme', tema);
            localStorage.setItem('colorTheme', tema);
        }

        async function cargarLogoEmpresa() {
            // Usar connection (empresa_cli_id) para endpoints de logo
            const connection = localStorage.getItem('connection');
            if (!connection) {
                console.warn('No hay connection en localStorage, usando valores por defecto');
                applyColorTheme('rubi');
                return;
            }
            const logoElements = document.querySelectorAll('.logo');
            try {
                const configResponse = await fetch(`${API_URL}/api/empresa/${connection}/config`);
                const config = await configResponse.json();
                applyColorTheme(config.tema || 'rubi');
                const invertirFilter = config.invertir_logo ? 'brightness(0) invert(1)' : 'none';
                if (config.tiene_logo) {
                    const logoUrl = `${API_URL}/api/empresa/${connection}/logo?t=${Date.now()}`;
                    logoElements.forEach(el => {
                        el.src = logoUrl;
                        el.style.filter = invertirFilter;
                        el.style.visibility = 'visible';
                    });
                } else {
                    logoElements.forEach(el => {
                        el.src = 'assets/logo.svg';
                        el.style.filter = 'brightness(0) invert(1)';
                        el.style.visibility = 'visible';
                    });
                }
            } catch (error) {
                console.log('Error al cargar logo:', error);
                applyColorTheme('rubi');
                logoElements.forEach(el => {
                    el.src = 'assets/logo.svg';
                    el.style.filter = 'brightness(0) invert(1)';
                    el.style.visibility = 'visible';
                });
            }
        }

        let allProposals = [];
        let filteredProposals = [];
        let csrfToken = null;

        // ==================== ORDENACI√ìN Y FILTROS DE COLUMNAS ====================
        let ordenActual = { columna: 'fecha', direccion: 'DESC' };
        let filtrosColumna = [];
        let popupFiltroAbierto = null;

        // Operadores disponibles
        const operadoresTexto = [
            { key: 'contains', label: 'Contiene' },
            { key: 'not_contains', label: 'No contiene', negativo: true },
            { key: 'eq', label: 'Igual a' },
            { key: 'neq', label: 'No igual a', negativo: true },
            { key: 'starts', label: 'Empieza por' },
            { key: 'ends', label: 'Termina en' }
        ];

        // Columnas disponibles para filtrar
        const columnasFiltrables = [
            { key: 'id', label: 'ID', tipo: 'numero' },
            { key: 'usuario', label: 'Usuario', tipo: 'texto' },
            { key: 'fecha', label: 'Fecha', tipo: 'fecha' },
            { key: 'estado', label: 'Estado', tipo: 'texto' },
            { key: 'referencia', label: 'Referencia', tipo: 'texto' }
        ];

        // ==================== CSRF TOKEN ====================
        async function obtenerCsrfToken() {
            try {
                // Primero intentar obtener de localStorage
                csrfToken = localStorage.getItem('csrf_token');

                // Luego obtener del servidor (puede ser m√°s reciente)
                const response = await fetch(`${API_URL}/api/csrf-token`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    csrfToken = data.csrf_token;
                    localStorage.setItem('csrf_token', csrfToken);
                }
            } catch (e) {
                console.error('Error obteniendo CSRF token:', e);
            }
        }

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar logo de empresa (usa connection de localStorage)
            await cargarLogoEmpresa();

            // Inicializar i18n
            await I18n.init();

            // Actualizar selector de idioma
            const langSelector = document.getElementById('lang-selector');
            if (langSelector) {
                langSelector.value = I18n.currentLang;
            }

            // Verificar autenticaci√≥n y permisos de admin
            await checkAuth();

            // Obtener CSRF token
            await obtenerCsrfToken();

            // Cargar propuestas
            await loadProposals();
        });

        // ==================== AUTENTICACI√ìN ====================
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/api/current-user`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = await response.json();

                // Verificar que sea administrador o superusuario
                if (user.rol !== 'administrador' && user.rol !== 'superusuario') {
                    alert('No tienes permisos para acceder a esta p√°gina');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = 'login.html';
            }
        }

        // ==================== CARGAR PROPUESTAS ====================
        async function loadProposals() {
            const loadingEl = document.getElementById('proposals-loading');
            const emptyEl = document.getElementById('proposals-empty');
            const tableWrapper = document.getElementById('proposals-table-wrapper');

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/propuestas`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        alert('No tienes permisos para ver todas las propuestas');
                        window.location.href = 'index.html';
                        return;
                    }
                    throw new Error('Error loading proposals');
                }

                const data = await response.json();
                allProposals = data.propuestas || [];
                filteredProposals = [...allProposals];

                loadingEl.style.display = 'none';

                if (allProposals.length === 0) {
                    emptyEl.style.display = 'block';
                    tableWrapper.style.display = 'none';
                } else {
                    emptyEl.style.display = 'none';
                    tableWrapper.style.display = 'block';
                    renderProposals();
                }
            } catch (error) {
                console.error('Error loading proposals:', error);
                loadingEl.innerHTML = `<p style="color: #dc3545;">Error al cargar las propuestas</p>`;
            }
        }

        // ==================== FILTRAR PROPUESTAS ====================
        function applyFilters() {
            const estado = document.getElementById('filter-estado').value;
            const fechaDesde = document.getElementById('filter-fecha-desde').value;
            const fechaHasta = document.getElementById('filter-fecha-hasta').value;

            filteredProposals = allProposals.filter(proposal => {
                // Filtrar por estado
                if (estado && proposal.estado !== estado) {
                    return false;
                }

                // Filtrar por fecha desde
                if (fechaDesde) {
                    const proposalDate = new Date(proposal.fecha);
                    const filterDate = new Date(fechaDesde);
                    if (proposalDate < filterDate) {
                        return false;
                    }
                }

                // Filtrar por fecha hasta
                if (fechaHasta) {
                    const proposalDate = new Date(proposal.fecha);
                    const filterDate = new Date(fechaHasta);
                    filterDate.setHours(23, 59, 59, 999);  // Fin del d√≠a
                    if (proposalDate > filterDate) {
                        return false;
                    }
                }

                return true;
            });

            renderProposals();
        }

        function clearFilters() {
            document.getElementById('filter-estado').value = '';
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';

            filteredProposals = [...allProposals];
            renderProposals();
        }

        // ==================== RENDERIZAR PROPUESTAS ====================
        function renderProposals() {
            const tableBody = document.getElementById('proposals-table-body');
            const cardsEl = document.getElementById('proposals-cards');
            const emptyEl = document.getElementById('proposals-empty');
            const tableWrapper = document.getElementById('proposals-table-wrapper');

            if (filteredProposals.length === 0) {
                emptyEl.style.display = 'block';
                tableWrapper.style.display = 'none';
                cardsEl.innerHTML = '';
                return;
            }

            emptyEl.style.display = 'none';
            tableWrapper.style.display = 'block';

            // Renderizar tabla
            tableBody.innerHTML = filteredProposals.map(proposal => `
                <tr>
                    <td><strong>#${proposal.id}</strong></td>
                    <td>
                        <span class="user-badge">
                            <span class="user-badge-icon">üë§</span>
                            ${proposal.username || 'Usuario'}
                        </span>
                    </td>
                    <td>${formatDate(proposal.fecha)}</td>
                    <td>${proposal.total_items} ${t('proposals.items').toLowerCase()}</td>
                    <td>${getStatusBadge(proposal.estado)}</td>
                    <td>${proposal.referencia || '-'}</td>
                    <td>
                        <div class="status-actions">
                            <button class="btn-view-details" onclick="viewProposalDetails(${proposal.id})">
                                ${t('proposals.viewDetails')}
                            </button>
                            <button class="btn-download-excel" onclick="downloadExcel(${proposal.id})" title="${t('proposals.downloadExcel')}">
                                üì• Excel
                            </button>
                            ${proposal.estado === 'Enviada' ? `
                                <button class="btn-status btn-status-process" onclick="changeStatus(${proposal.id}, 'Procesada')">
                                    ${t('proposals.statusProcessed')}
                                </button>
                                <button class="btn-status btn-status-cancel" onclick="changeStatus(${proposal.id}, 'Cancelada')">
                                    ${t('proposals.statusCancelled')}
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            // Renderizar cards (m√≥vil)
            cardsEl.innerHTML = filteredProposals.map(proposal => `
                <div class="proposal-card">
                    <div class="proposal-card-header">
                        <span class="proposal-card-id">#${proposal.id}</span>
                        ${getStatusBadge(proposal.estado)}
                    </div>
                    <div class="proposal-card-user">
                        <span class="user-badge">
                            <span class="user-badge-icon">üë§</span>
                            ${proposal.username || 'Usuario'}
                        </span>
                    </div>
                    <div class="proposal-card-date">${formatDate(proposal.fecha)}</div>
                    <div class="proposal-card-info">
                        <div class="proposal-card-info-item">
                            <label>${t('proposals.items')}</label>
                            <span>${proposal.total_items}</span>
                        </div>
                        ${proposal.referencia ? `
                        <div class="proposal-card-info-item">
                            <label>${t('proposals.reference')}</label>
                            <span>${proposal.referencia}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="proposal-card-actions">
                        <div class="action-buttons" style="width: 100%; justify-content: center;">
                            <button class="btn-view-details" onclick="viewProposalDetails(${proposal.id})">
                                ${t('proposals.viewDetails')}
                            </button>
                            <button class="btn-download-excel" onclick="downloadExcel(${proposal.id})" title="${t('proposals.downloadExcel')}">
                                üì• Excel
                            </button>
                        </div>
                        ${proposal.estado === 'Enviada' ? `
                            <div class="status-actions" style="justify-content: center; margin-top: 8px;">
                                <button class="btn-status btn-status-process" onclick="changeStatus(${proposal.id}, 'Procesada')">
                                    ${t('proposals.statusProcessed')}
                                </button>
                                <button class="btn-status btn-status-cancel" onclick="changeStatus(${proposal.id}, 'Cancelada')">
                                    ${t('proposals.statusCancelled')}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ==================== DESCARGAR EXCEL ====================
        async function downloadExcel(proposalId) {
            try {
                const response = await fetch(`${API_URL}/api/propuestas/${proposalId}/excel`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error al descargar Excel');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `propuesta_${proposalId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Error downloading Excel:', error);
                alert(t('proposals.downloadExcelError'));
            }
        }

        // ==================== CAMBIAR ESTADO ====================
        async function changeStatus(proposalId, newStatus) {
            const statusText = newStatus === 'Procesada' ? t('proposals.statusProcessed') : t('proposals.statusCancelled');

            if (!confirm(`¬øCambiar el estado a "${statusText}"?`)) {
                return;
            }

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/propuestas/${proposalId}/estado`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Error changing status');
                }

                // Actualizar la propuesta en la lista local
                const index = allProposals.findIndex(p => p.id === proposalId);
                if (index !== -1) {
                    allProposals[index].estado = newStatus;
                }

                // Actualizar en filteredProposals tambi√©n
                const filteredIndex = filteredProposals.findIndex(p => p.id === proposalId);
                if (filteredIndex !== -1) {
                    filteredProposals[filteredIndex].estado = newStatus;
                }

                renderProposals();
            } catch (error) {
                console.error('Error changing status:', error);
                alert('Error al cambiar el estado');
            }
        }

        // ==================== VER DETALLE DE PROPUESTA ====================
        async function viewProposalDetails(proposalId) {
            const modal = document.getElementById('proposal-detail-modal');
            const content = document.getElementById('proposal-detail-content');

            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="proposals-loading">
                    <div class="spinner"></div>
                    <p>${t('common.loading')}</p>
                </div>
            `;

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/propuestas/${proposalId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error loading proposal details');
                }

                const data = await response.json();
                const proposal = data.propuesta;
                const lines = proposal.lineas || [];

                // Renderizar primero sin im√°genes, luego cargarlas
                content.innerHTML = `
                    <div class="proposal-info">
                        <div class="proposal-info-item">
                            <label>ID</label>
                            <span>#${proposal.id}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.user')}</label>
                            <span>${proposal.username || 'Usuario'}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.date')}</label>
                            <span>${formatDate(proposal.fecha)}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.status')}</label>
                            <span>${getStatusBadge(proposal.estado)}</span>
                        </div>
                        <div class="proposal-info-item">
                            <label>${t('proposals.items')}</label>
                            <span>${proposal.total_items}</span>
                        </div>
                        ${proposal.referencia ? `
                        <div class="proposal-info-item">
                            <label>${t('proposals.reference')}</label>
                            <span>${proposal.referencia}</span>
                        </div>
                        ` : ''}
                    </div>

                    ${proposal.comentarios ? `
                        <div class="proposal-comments">
                            <h4>${t('proposals.comments')}</h4>
                            <p>${proposal.comentarios}</p>
                        </div>
                    ` : ''}

                    <h3 class="proposal-lines-title">${t('proposals.items')}</h3>

                    <!-- Lista de productos con im√°genes -->
                    <div class="proposal-lines-list">
                        ${lines.map((line, index) => `
                            <div class="proposal-line-item">
                                <div class="proposal-line-image" data-img-index="${index}">
                                    <div class="no-image loading-img">‚è≥</div>
                                </div>
                                <div class="proposal-line-info">
                                    <div class="proposal-line-header">
                                        <span class="proposal-line-code">${line.codigo}</span>
                                        <span class="proposal-line-qty">${line.cantidad_solicitada} ${line.unidad}</span>
                                    </div>
                                    <div class="proposal-line-desc">${line.descripcion}</div>
                                    <div class="proposal-line-details">
                                        <span class="detail-tag">${line.formato}</span>
                                        <span class="detail-tag">${line.calidad}</span>
                                        ${line.color ? `<span class="detail-tag">${line.color}</span>` : ''}
                                        ${line.tono ? `<span class="detail-tag">T:${line.tono}</span>` : ''}
                                        ${line.calibre ? `<span class="detail-tag">C:${line.calibre}</span>` : ''}
                                    </div>
                                    <div class="proposal-line-packing">
                                        ${line.pallet ? `<span class="packing-tag">üì¶ Pallet: ${line.pallet}</span>` : ''}
                                        ${line.caja ? `<span class="packing-tag">üóÉÔ∏è Caja: ${line.caja}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                // Cargar im√°genes de cada producto
                lines.forEach((line, index) => {
                    cargarImagenProducto(line.codigo, index);
                });
            } catch (error) {
                console.error('Error loading proposal details:', error);
                content.innerHTML = `<p style="color: #dc3545; text-align: center;">Error al cargar los detalles</p>`;
            }
        }

        // ==================== CARGAR IMAGEN DE PRODUCTO ====================
        async function cargarImagenProducto(codigo, index) {
            const container = document.querySelector(`[data-img-index="${index}"]`);
            if (!container) return;

            try {
                const response = await fetch(`${API_URL}/api/stocks/${encodeURIComponent(codigo)}/imagenes`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const imagenes = await response.json();
                    if (imagenes.length > 0 && imagenes[0].imagen) {
                        // Imagen clickable con galer√≠a si hay m√∫ltiples
                        const imgBase64 = imagenes[0].imagen;
                        const totalImgs = imagenes.length;
                        container.innerHTML = `
                            <img src="data:image/jpeg;base64,${imgBase64}"
                                 alt="${codigo}"
                                 style="width:100%;height:100%;object-fit:cover;border-radius:8px;cursor:pointer;"
                                 onclick="ampliarImagen('${imgBase64}')">
                            ${totalImgs > 1 ? `<span class="img-count">+${totalImgs - 1}</span>` : ''}
                        `;
                        // Guardar todas las im√°genes para la galer√≠a
                        container.dataset.imagenes = JSON.stringify(imagenes.map(i => i.imagen));
                        container.dataset.codigo = codigo;
                        container.onclick = () => abrirGaleria(container.dataset.imagenes, codigo);
                    } else {
                        container.innerHTML = `<div class="no-image">üì¶</div>`;
                    }
                } else {
                    container.innerHTML = `<div class="no-image">üì¶</div>`;
                }
            } catch (e) {
                console.log('Error cargando imagen:', codigo, e);
                container.innerHTML = `<div class="no-image">üì¶</div>`;
            }
        }

        // ==================== GALER√çA DE IM√ÅGENES ====================
        function abrirGaleria(imagenesJson, codigo) {
            const imagenes = JSON.parse(imagenesJson);
            if (!imagenes || imagenes.length === 0) return;

            // Crear modal de galer√≠a
            let modal = document.getElementById('galeria-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'galeria-modal';
                modal.className = 'galeria-modal';
                modal.innerHTML = `
                    <div class="galeria-content">
                        <button class="galeria-close" onclick="cerrarGaleria()">√ó</button>
                        <div class="galeria-main">
                            <img id="galeria-img-principal" src="" alt="Imagen">
                        </div>
                        <div class="galeria-thumbs" id="galeria-thumbs"></div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Cerrar al hacer clic fuera
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) cerrarGaleria();
                });
            }

            // Llenar galer√≠a
            const imgPrincipal = document.getElementById('galeria-img-principal');
            const thumbsContainer = document.getElementById('galeria-thumbs');

            imgPrincipal.src = `data:image/jpeg;base64,${imagenes[0]}`;

            thumbsContainer.innerHTML = imagenes.map((img, i) => `
                <div class="galeria-thumb ${i === 0 ? 'active' : ''}" onclick="seleccionarImagen('${img}', this)">
                    <img src="data:image/jpeg;base64,${img}" alt="Thumb ${i + 1}">
                </div>
            `).join('');

            modal.style.display = 'flex';
        }

        function seleccionarImagen(imgBase64, thumbEl) {
            document.getElementById('galeria-img-principal').src = `data:image/jpeg;base64,${imgBase64}`;
            document.querySelectorAll('.galeria-thumb').forEach(t => t.classList.remove('active'));
            thumbEl.classList.add('active');
        }

        function cerrarGaleria() {
            const modal = document.getElementById('galeria-modal');
            if (modal) modal.style.display = 'none';
        }

        function ampliarImagen(imgBase64) {
            abrirGaleria(JSON.stringify([imgBase64]), '');
        }

        // ==================== CERRAR MODAL ====================
        function closeProposalModal() {
            document.getElementById('proposal-detail-modal').style.display = 'none';
        }

        // ==================== UTILIDADES ====================
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusBadge(status) {
            const statusMap = {
                'Enviada': { class: 'status-enviada', key: 'proposals.statusSent' },
                'Procesada': { class: 'status-procesada', key: 'proposals.statusProcessed' },
                'Cancelada': { class: 'status-cancelada', key: 'proposals.statusCancelled' }
            };

            const statusInfo = statusMap[status] || { class: 'status-enviada', key: 'proposals.statusSent' };
            return `<span class="status-badge ${statusInfo.class}">${t(statusInfo.key)}</span>`;
        }

        function goBack() {
            const empresaId = localStorage.getItem('empresa_id');
            window.location.href = `index.html?empresa=${empresaId}`;
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('proposal-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProposalModal();
            }
        });

        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeProposalModal();
                cerrarPopupFiltro();
            }
        });

        // ==================== ORDENACI√ìN POR COLUMNAS ====================
        function ordenarPor(columna) {
            if (ordenActual.columna === columna) {
                ordenActual.direccion = ordenActual.direccion === 'ASC' ? 'DESC' : 'ASC';
            } else {
                ordenActual.columna = columna;
                ordenActual.direccion = 'ASC';
            }
            actualizarIconosOrdenacion();
            aplicarFiltrosYOrdenacion();
        }

        function actualizarIconosOrdenacion() {
            document.querySelectorAll('.proposals-table th .sort-icon').forEach(icon => {
                icon.classList.remove('active', 'asc', 'desc');
            });
            const thActivo = document.querySelector(`.proposals-table th[data-column="${ordenActual.columna}"] .sort-icon`);
            if (thActivo) {
                thActivo.classList.add('active', ordenActual.direccion.toLowerCase());
            }
        }

        // ==================== FILTROS POR COLUMNA ====================
        function abrirPopupFiltro(columna, elemento) {
            cerrarPopupFiltro();

            const colConfig = columnasFiltrables.find(c => c.key === columna);
            if (!colConfig) return;

            const filtroExistente = filtrosColumna.find(f => f.columna === columna);
            const valoresUnicos = obtenerValoresUnicos(columna);

            const popup = document.createElement('div');
            popup.className = 'filter-popup';
            popup.innerHTML = `
                <div class="filter-popup-header">
                    <span class="filter-popup-title">${colConfig.label}</span>
                    <button class="filter-popup-close" onclick="cerrarPopupFiltro()">√ó</button>
                </div>
                <div class="filter-popup-content">
                    <div class="filter-condition-operators">
                        ${operadoresTexto.map((op, idx) => `
                            <label class="filter-condition-option ${op.negativo ? 'negativo' : ''}">
                                <input type="radio" name="op-${columna}" value="${op.key}"
                                       ${(filtroExistente?.operador === op.key || (!filtroExistente && idx === 0)) ? 'checked' : ''}>
                                <span class="filter-radio-dot"></span>
                                ${op.label}
                            </label>
                        `).join('')}
                    </div>
                    <div class="filter-inputs-container">
                        <input type="text" class="filter-condition-input" id="filter-value-${columna}"
                               placeholder="Valor..." value="${filtroExistente?.valor || ''}"
                               onkeypress="if(event.key==='Enter') aplicarFiltroColumna('${columna}')">
                    </div>
                    ${valoresUnicos.length > 0 && valoresUnicos.length <= 20 ? `
                    <div class="filter-values-list" id="filter-values-list-${columna}">
                        ${valoresUnicos.map(v => `
                            <label class="filter-value-item">
                                <input type="checkbox" value="${v}" ${filtroExistente?.valores?.includes(v) ? 'checked' : ''}>
                                <span>${v || '(vac√≠o)'}</span>
                            </label>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
                <div class="filter-popup-footer">
                    <button class="btn-filter-clear" onclick="limpiarFiltroColumna('${columna}')" title="Limpiar">
                        <svg viewBox="0 0 16 16" fill="currentColor" width="12" height="12"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    </button>
                    <button class="btn-filter-apply" onclick="aplicarFiltroColumna('${columna}')">
                        <svg viewBox="0 0 16 16" fill="currentColor" width="12" height="12"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>
                        Aplicar
                    </button>
                </div>
            `;

            const rect = elemento.getBoundingClientRect();
            popup.style.position = 'fixed';
            popup.style.top = `${rect.bottom + 5}px`;
            popup.style.left = `${Math.min(rect.left, window.innerWidth - 280)}px`;
            popup.style.zIndex = '1000';

            document.body.appendChild(popup);
            popupFiltroAbierto = popup;

            popup.addEventListener('click', (e) => e.stopPropagation());
        }

        function cerrarPopupFiltro() {
            if (popupFiltroAbierto) {
                popupFiltroAbierto.remove();
                popupFiltroAbierto = null;
            }
        }

        function obtenerValoresUnicos(columna) {
            const valores = new Set();
            allProposals.forEach(p => {
                let valor = p[columna];
                if (columna === 'usuario') valor = p.username;
                if (valor !== undefined && valor !== null) valores.add(String(valor));
            });
            return Array.from(valores).sort();
        }

        function aplicarFiltroColumna(columna) {
            const inputValor = document.getElementById(`filter-value-${columna}`);
            const radioSeleccionado = document.querySelector(`input[name="op-${columna}"]:checked`);
            const checkboxes = document.querySelectorAll(`#filter-values-list-${columna} input[type="checkbox"]:checked`);

            const valorInput = inputValor?.value.trim();
            const operador = radioSeleccionado?.value || 'contains';
            const valoresSeleccionados = Array.from(checkboxes).map(cb => cb.value);

            filtrosColumna = filtrosColumna.filter(f => f.columna !== columna);

            if (valoresSeleccionados.length > 0) {
                filtrosColumna.push({ columna, operador: 'in', valores: valoresSeleccionados });
            } else if (valorInput) {
                filtrosColumna.push({ columna, operador, valor: valorInput });
            }

            cerrarPopupFiltro();
            renderizarChipsFiltros();
            actualizarIconosFiltro();
            aplicarFiltrosYOrdenacion();
        }

        function limpiarFiltroColumna(columna) {
            filtrosColumna = filtrosColumna.filter(f => f.columna !== columna);
            cerrarPopupFiltro();
            renderizarChipsFiltros();
            actualizarIconosFiltro();
            aplicarFiltrosYOrdenacion();
        }

        function limpiarTodosFiltrosColumna() {
            filtrosColumna = [];
            renderizarChipsFiltros();
            actualizarIconosFiltro();
            aplicarFiltrosYOrdenacion();
        }

        function renderizarChipsFiltros() {
            const container = document.getElementById('column-filters-chips');
            if (!container) return;

            if (filtrosColumna.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = filtrosColumna.map((filtro, idx) => {
                const labelColumna = columnasFiltrables.find(c => c.key === filtro.columna)?.label || filtro.columna;
                const esNegativo = filtro.operador?.startsWith('not_') || filtro.operador === 'neq';
                const chipClass = esNegativo ? 'filter-chip filter-chip-negative' : 'filter-chip';

                if (filtro.operador === 'in' && filtro.valores) {
                    const valorMostrar = filtro.valores.length <= 2
                        ? filtro.valores.join(', ')
                        : `${filtro.valores[0]}... (+${filtro.valores.length - 1})`;
                    return `<span class="filter-chip filter-chip-multi">
                        <span class="filter-chip-column">${labelColumna}:</span>
                        <span class="filter-chip-value">${valorMostrar}</span>
                        <span class="filter-chip-remove" onclick="quitarFiltroColumna(${idx})">‚úï</span>
                    </span>`;
                } else {
                    const opLabel = operadoresTexto.find(o => o.key === filtro.operador)?.label || filtro.operador;
                    return `<span class="${chipClass}">
                        <span class="filter-chip-column">${labelColumna}:</span>
                        <span class="filter-chip-operator">${opLabel.toLowerCase()}</span>
                        <span class="filter-chip-value">"${filtro.valor}"</span>
                        <span class="filter-chip-remove" onclick="quitarFiltroColumna(${idx})">‚úï</span>
                    </span>`;
                }
            }).join('') + `<button class="btn-clear-filters" onclick="limpiarTodosFiltrosColumna()">Limpiar todo</button>`;
        }

        function quitarFiltroColumna(index) {
            filtrosColumna.splice(index, 1);
            renderizarChipsFiltros();
            actualizarIconosFiltro();
            aplicarFiltrosYOrdenacion();
        }

        function actualizarIconosFiltro() {
            columnasFiltrables.forEach(col => {
                const btn = document.querySelector(`.proposals-table th[data-column="${col.key}"] .column-filter-btn`);
                if (btn) {
                    const tieneFiltro = filtrosColumna.some(f => f.columna === col.key);
                    btn.classList.toggle('active', tieneFiltro);
                }
            });
        }

        function aplicarFiltrosYOrdenacion() {
            let datos = [...allProposals];

            // Aplicar filtros de columna
            filtrosColumna.forEach(filtro => {
                datos = datos.filter(item => {
                    let valorItem = item[filtro.columna];
                    if (filtro.columna === 'usuario') valorItem = item.username;
                    valorItem = String(valorItem || '').toLowerCase();

                    if (filtro.operador === 'in') {
                        return filtro.valores.some(v => valorItem === v.toLowerCase());
                    }

                    const valorBuscar = (filtro.valor || '').toLowerCase();
                    switch (filtro.operador) {
                        case 'eq': return valorItem === valorBuscar;
                        case 'neq': return valorItem !== valorBuscar;
                        case 'contains': return valorItem.includes(valorBuscar);
                        case 'not_contains': return !valorItem.includes(valorBuscar);
                        case 'starts': return valorItem.startsWith(valorBuscar);
                        case 'ends': return valorItem.endsWith(valorBuscar);
                        default: return valorItem.includes(valorBuscar);
                    }
                });
            });

            // Aplicar ordenaci√≥n
            datos.sort((a, b) => {
                let valA = a[ordenActual.columna];
                let valB = b[ordenActual.columna];
                if (ordenActual.columna === 'usuario') {
                    valA = a.username;
                    valB = b.username;
                }

                if (ordenActual.columna === 'fecha') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }

                if (valA < valB) return ordenActual.direccion === 'ASC' ? -1 : 1;
                if (valA > valB) return ordenActual.direccion === 'ASC' ? 1 : -1;
                return 0;
            });

            filteredProposals = datos;
            renderProposals(filteredProposals);
        }

        // Cerrar popup al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (popupFiltroAbierto && !popupFiltroAbierto.contains(e.target) && !e.target.classList.contains('column-filter-btn')) {
                cerrarPopupFiltro();
            }
        });
    </script>
</body>
</html>
