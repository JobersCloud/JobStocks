<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busqueda Magica</title>
    <script src="js/theme-init.js?v=1.34.0"></script>
    <link rel="stylesheet" href="css/styles.css?v=1.29.2">
    <style>
        /* ==================== MAGIC SEARCH LAYOUT ==================== */
        .magic-search-container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .magic-search-header {
            margin-bottom: 24px;
        }

        .magic-search-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary, #1a1a2e);
            margin: 0 0 4px 0;
        }

        .magic-search-header p {
            font-size: 0.9rem;
            color: var(--text-secondary, #666);
            margin: 0;
        }

        /* ==================== DROP ZONE ==================== */
        .drop-zone-wrapper {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .drop-zone {
            flex: 1;
            min-width: 280px;
            min-height: 220px;
            border: 2px dashed var(--border-color, #d0d0d0);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            background: var(--bg-secondary, #f8f9fa);
            padding: 32px 24px;
            position: relative;
        }

        .drop-zone:hover {
            border-color: var(--primary, #e74c3c);
            background: var(--bg-hover, #fff5f5);
        }

        .drop-zone.drag-over {
            border-color: var(--primary, #e74c3c);
            background: var(--bg-hover, #fff5f5);
            border-style: solid;
            transform: scale(1.01);
        }

        .drop-zone-icon {
            width: 56px;
            height: 56px;
            color: var(--text-secondary, #999);
            transition: color 0.25s ease;
        }

        .drop-zone:hover .drop-zone-icon,
        .drop-zone.drag-over .drop-zone-icon {
            color: var(--primary, #e74c3c);
        }

        .drop-zone-text {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary, #333);
            text-align: center;
        }

        .drop-zone-hint {
            font-size: 0.8rem;
            color: var(--text-secondary, #999);
            text-align: center;
        }

        .drop-zone input[type="file"] {
            display: none;
        }

        /* ==================== IMAGE PREVIEW ==================== */
        .image-preview-panel {
            width: 280px;
            min-height: 220px;
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 16px;
            background: var(--bg-secondary, #f8f9fa);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            position: relative;
        }

        .image-preview-panel.has-image {
            justify-content: flex-start;
        }

        .image-preview-placeholder {
            color: var(--text-secondary, #bbb);
            font-size: 0.85rem;
            text-align: center;
        }

        .image-preview-panel img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            object-fit: contain;
        }

        .image-preview-filename {
            font-size: 0.75rem;
            color: var(--text-secondary, #888);
            margin-top: 8px;
            word-break: break-all;
            text-align: center;
        }

        .image-preview-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.5);
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s;
        }

        .image-preview-remove:hover {
            background: rgba(220, 53, 69, 0.85);
        }

        /* ==================== SEARCH BUTTON ==================== */
        .search-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-magic-search {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, var(--primary, #e74c3c) 0%, var(--primary-dark, #c0392b) 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .btn-magic-search:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        }

        .btn-magic-search:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .btn-magic-search svg {
            width: 20px;
            height: 20px;
        }

        .search-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-magic-search.loading .search-spinner {
            display: inline-block;
        }

        .btn-magic-search.loading .search-icon-svg {
            display: none;
        }

        /* ==================== RESULTS SECTION ==================== */
        .results-section {
            margin-bottom: 32px;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .results-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary, #333);
        }

        .results-count {
            font-size: 0.85rem;
            color: var(--text-secondary, #888);
            background: var(--bg-secondary, #f0f0f0);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .similarity-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 700;
        }

        .similarity-badge.high {
            background: rgba(40, 167, 69, 0.12);
            color: #28a745;
        }

        .similarity-badge.medium {
            background: rgba(255, 193, 7, 0.15);
            color: #d4a017;
        }

        .similarity-badge.low {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        /* ==================== EMPTY STATE ==================== */
        .results-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            color: var(--text-secondary, #aaa);
            text-align: center;
        }

        .results-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .results-empty p {
            font-size: 0.95rem;
            margin: 0;
        }

        /* ==================== DARK MODE ==================== */
        [data-theme="dark"] .magic-search-header h2 {
            color: #e0e0e0;
        }

        [data-theme="dark"] .magic-search-header p {
            color: #aaa;
        }

        [data-theme="dark"] .drop-zone {
            background: #1e1e2e;
            border-color: #444;
        }

        [data-theme="dark"] .drop-zone:hover,
        [data-theme="dark"] .drop-zone.drag-over {
            background: #2a2040;
            border-color: var(--primary, #e74c3c);
        }

        [data-theme="dark"] .drop-zone-text {
            color: #ddd;
        }

        [data-theme="dark"] .drop-zone-hint {
            color: #888;
        }

        [data-theme="dark"] .image-preview-panel {
            background: #1e1e2e;
            border-color: #444;
        }

        [data-theme="dark"] .image-preview-placeholder {
            color: #666;
        }

        [data-theme="dark"] .image-preview-filename {
            color: #888;
        }

        [data-theme="dark"] .results-title {
            color: #e0e0e0;
        }

        [data-theme="dark"] .results-count {
            background: #2a2a3a;
            color: #aaa;
        }

        [data-theme="dark"] .results-empty {
            color: #666;
        }

        [data-theme="dark"] .similarity-badge.high {
            background: rgba(40, 167, 69, 0.2);
        }

        [data-theme="dark"] .similarity-badge.medium {
            background: rgba(255, 193, 7, 0.2);
        }

        [data-theme="dark"] .similarity-badge.low {
            background: rgba(220, 53, 69, 0.15);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .magic-search-container {
                padding: 16px;
            }

            .drop-zone-wrapper {
                flex-direction: column;
            }

            .image-preview-panel {
                width: 100%;
                min-height: 160px;
            }

            .index-stats {
                gap: 16px;
            }
        }
    </style>
</head>
<body style="overflow: hidden; height: 100vh;">
    <div class="app-layout">
        <!-- Header Superior -->
        <header class="top-header">
            <div class="top-header-left">
                <button class="mobile-menu-btn" onclick="toggleSidebarMobile()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="header-logo">
                    <img src="" alt="Logo" id="header-logo" style="visibility:hidden">
                    <span class="header-logo-text" id="header-company-name">Stocks</span>
                </div>
                <div class="header-divider"></div>
                <div>
                    <h1 class="top-header-title" data-i18n="magicSearch.title">Busqueda Magica</h1>
                </div>
            </div>
            <div class="top-header-right">
                <div class="bell-container">
                    <button class="bell-btn" onclick="Notifications.showDropdown()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        <span class="notification-badge" id="bell-badge">0</span>
                    </button>
                </div>
                <div class="menu-container">
                    <button class="menu-btn" id="menu-btn" onclick="toggleUserMenu()">
                        <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span class="user-name-display" id="user-name-display">Usuario</span>
                    </button>
                    <div class="menu-dropdown" id="menu-dropdown">
                        <div class="menu-header">
                            <div class="user-name" id="menu-user-name">Usuario</div>
                            <div class="user-rol" id="menu-user-rol">usuario</div>
                        </div>
                        <div class="menu-divider" id="menu-divider-context" style="display: none;"></div>
                        <a class="menu-item" id="menu-item-context" onclick="showContextInfo()" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <span data-i18n="menu.contextInfo">Info de Contexto</span>
                        </a>
                        <div class="menu-divider"></div>
                        <a class="menu-item" onclick="toggleTheme()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                            <span data-i18n="menu.darkMode">Modo oscuro</span>
                            <span class="menu-theme-icon" id="theme-icon">&#127769;</span>
                        </a>
                        <div class="menu-item menu-item-lang">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <select id="lang-selector" class="lang-selector-menu" onchange="I18n.setLanguage(this.value)">
                                <option value="es">Espanol</option>
                                <option value="en">English</option>
                                <option value="fr">Francais</option>
                            </select>
                        </div>
                        <div class="menu-divider"></div>
                        <a class="menu-item" onclick="showChangePasswordModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            <span data-i18n="menu.changePassword">Cambiar Contrasena</span>
                        </a>
                        <div class="menu-divider"></div>
                        <a class="menu-item menu-item-logout" onclick="logout()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span data-i18n="menu.logout">Cerrar Sesion</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-toggle-container">
                <button class="sidebar-toggle" title="Ctrl+B">&#9776;</button>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <a class="sidebar-item" data-page="index.html" data-tooltip="Stocks" onclick="SidebarNav.navigateTo('index.html')">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                        </span>
                        <span class="sidebar-item-text" data-i18n="menu.stocks">Stocks</span>
                    </a>
                    <a class="sidebar-item" data-page="mis-propuestas.html" data-tooltip="Mis Propuestas" onclick="SidebarNav.navigateTo('mis-propuestas.html')">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                        </span>
                        <span class="sidebar-item-text" data-i18n="menu.myProposals">Mis Propuestas</span>
                    </a>
                    <a class="sidebar-item" data-page="mis-pedidos.html" data-tooltip="Mis Pedidos" onclick="SidebarNav.navigateTo('mis-pedidos.html')">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="3" width="15" height="13"></rect>
                                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                <circle cx="18.5" cy="18.5" r="2.5"></circle>
                            </svg>
                        </span>
                        <span class="sidebar-item-text" data-i18n="menu.myOrders">Mis Pedidos</span>
                    </a>
                    <a class="sidebar-item" data-page="mis-consultas.html" data-tooltip="Mis Consultas" onclick="SidebarNav.navigateTo('mis-consultas.html')">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </span>
                        <span class="sidebar-item-text" data-i18n="menu.myInquiries">Mis Consultas</span>
                    </a>
                    <a class="sidebar-item active" data-page="busqueda-magica.html" data-tooltip="Busqueda Magica" onclick="SidebarNav.navigateTo('busqueda-magica.html')">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                <path d="M8 11h6"></path>
                                <path d="M11 8v6"></path>
                            </svg>
                        </span>
                        <span class="sidebar-item-text" data-i18n="magicSearch.title">Busqueda Magica</span>
                    </a>
                </div>

                <!-- Acordeon Administracion -->
                <div class="sidebar-accordion expanded" id="sidebar-admin-section" style="display: none;">
                    <div class="sidebar-accordion-header" onclick="toggleAccordion(this)">
                        <div class="sidebar-accordion-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span data-i18n="menu.administration">Administracion</span>
                        </div>
                        <svg class="sidebar-accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="sidebar-accordion-content">
                        <a class="sidebar-item" data-page="dashboard.html" data-tooltip="Dashboard" onclick="SidebarNav.navigateTo('dashboard.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"></line>
                                    <line x1="12" y1="20" x2="12" y2="4"></line>
                                    <line x1="6" y1="20" x2="6" y2="14"></line>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.dashboard">Dashboard</span>
                        </a>
                        <a class="sidebar-item" data-page="todas-propuestas.html" data-tooltip="Propuestas" onclick="SidebarNav.navigateTo('todas-propuestas.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.allProposals">Propuestas</span>
                        </a>
                        <a class="sidebar-item" data-page="todos-pedidos.html" data-tooltip="Pedidos" onclick="SidebarNav.navigateTo('todos-pedidos.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="3" width="15" height="13"></rect>
                                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.allOrders">Pedidos</span>
                        </a>
                        <a class="sidebar-item" data-page="todas-consultas.html" data-tooltip="Consultas" onclick="SidebarNav.navigateTo('todas-consultas.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.allInquiries">Consultas</span>
                        </a>
                        <a class="sidebar-item" data-page="usuarios.html" data-tooltip="Usuarios" onclick="SidebarNav.navigateTo('usuarios.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.users">Usuarios</span>
                        </a>
                        <a class="sidebar-item" data-page="auditoria.html" data-tooltip="Auditoria" onclick="SidebarNav.navigateTo('auditoria.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.audit">Auditoria</span>
                        </a>
                        <a class="sidebar-item" data-page="vista-almacen.html" data-tooltip="Vista Almacen" onclick="SidebarNav.navigateTo('vista-almacen.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.warehouseView">Vista Almacen</span>
                        </a>
                        <a class="sidebar-item" data-page="informe-almacen.html" data-tooltip="Informe Almacen" onclick="SidebarNav.navigateTo('informe-almacen.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.warehouseReport">Informe Almacen</span>
                        </a>
                    </div>
                </div>

                <!-- Acordeon Configuracion -->
                <div class="sidebar-accordion" id="sidebar-config-section" style="display: none;">
                    <div class="sidebar-accordion-header" onclick="toggleAccordion(this)">
                        <div class="sidebar-accordion-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span data-i18n="menu.settings">Configuracion</span>
                        </div>
                        <svg class="sidebar-accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="sidebar-accordion-content">
                        <a class="sidebar-item" data-page="email-config.html" data-tooltip="Email" onclick="SidebarNav.navigateTo('email-config.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                    <polyline points="22,6 12,13 2,6"></polyline>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.emailConfig">Email</span>
                        </a>
                        <a class="sidebar-item" data-page="parametros.html" data-tooltip="Parametros" onclick="SidebarNav.navigateTo('parametros.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="4" y1="21" x2="4" y2="14"></line>
                                    <line x1="4" y1="10" x2="4" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12" y2="3"></line>
                                    <line x1="20" y1="21" x2="20" y2="16"></line>
                                    <line x1="20" y1="12" x2="20" y2="3"></line>
                                    <line x1="1" y1="14" x2="7" y2="14"></line>
                                    <line x1="9" y1="8" x2="15" y2="8"></line>
                                    <line x1="17" y1="16" x2="23" y2="16"></line>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.parameters">Parametros</span>
                        </a>
                        <a class="sidebar-item" data-page="api-keys.html" data-tooltip="API Keys" onclick="SidebarNav.navigateTo('api-keys.html')"><span class="sidebar-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg></span><span class="sidebar-item-text" data-i18n="menu.apiKeys">API Keys</span></a>
                        <a class="sidebar-item" data-page="empresa-logo.html" data-tooltip="Logo" onclick="SidebarNav.navigateTo('empresa-logo.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.companyLogo">Logo</span>
                        </a>
                        <a class="sidebar-item" data-page="control-bd.html" data-tooltip="Control BD" onclick="SidebarNav.navigateTo('control-bd.html')">
                            <span class="sidebar-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                                </svg>
                            </span>
                            <span class="sidebar-item-text" data-i18n="menu.dbControl">Control BD</span>
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Footer del Sidebar -->
            <div class="sidebar-footer">
                <a class="sidebar-item" data-tooltip="Cerrar Sesion" onclick="logout()">
                    <span class="sidebar-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </span>
                    <span class="sidebar-item-text" data-i18n="menu.logout">Cerrar Sesion</span>
                </a>
            </div>
        </aside>

        <!-- Overlay para movil -->
        <div class="sidebar-overlay"></div>

        <!-- Contenedor Principal -->
        <div class="main-wrapper">
            <main class="main-content-area" style="padding-top: 70px;">

                <div class="magic-search-container">
                    <!-- Header -->
                    <div class="magic-search-header">
                        <h2 data-i18n="magicSearch.title">Busqueda Magica</h2>
                        <p data-i18n="magicSearch.subtitle">Arrastra una imagen para encontrar productos similares mediante CBIR (busqueda por contenido visual)</p>
                    </div>

                    <!-- Drop Zone + Preview -->
                    <div class="drop-zone-wrapper">
                        <div class="drop-zone" id="drop-zone">
                            <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <div class="drop-zone-text" data-i18n="magicSearch.dropText">Arrastra una imagen aqui o haz clic para seleccionar</div>
                            <div class="drop-zone-hint" data-i18n="magicSearch.dropHint">Formatos: JPG, PNG, WEBP - Max 10MB</div>
                            <input type="file" id="file-input" accept="image/jpeg,image/png,image/webp">
                        </div>

                        <div class="image-preview-panel" id="preview-panel">
                            <div class="image-preview-placeholder" id="preview-placeholder">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 8px; display: block; margin-left: auto; margin-right: auto;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <span data-i18n="magicSearch.previewEmpty">Sin imagen seleccionada</span>
                            </div>
                            <img id="preview-image" src="" alt="Preview" style="display: none;">
                            <div id="preview-filename" class="image-preview-filename" style="display: none;"></div>
                            <button class="image-preview-remove" id="preview-remove" style="display: none;" title="Eliminar imagen">&times;</button>
                        </div>
                    </div>

                    <!-- Search Actions -->
                    <div class="search-actions">
                        <button class="btn-magic-search" id="btn-search" onclick="searchByImage()" disabled>
                            <span class="search-spinner"></span>
                            <svg class="search-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <span data-i18n="magicSearch.searchButton">Buscar productos similares</span>
                        </button>
                    </div>

                    <!-- Results Section -->
                    <div class="results-section" id="results-section" style="display: none;">
                        <div class="results-header">
                            <span class="results-title" data-i18n="magicSearch.resultsTitle">Resultados</span>
                            <span class="results-count" id="results-count"></span>
                        </div>
                        <div class="stock-grid-images" id="results-grid"></div>
                    </div>

                    <!-- Empty Results -->
                    <div class="results-empty" id="results-empty" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                        <p data-i18n="magicSearch.noResults">No se encontraron productos similares</p>
                    </div>



                </div>

            </main>
        </div>
    </div>

    <!-- Modal de detalle del stock (idéntico al de index.html) -->
    <div class="detail-modal" id="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="detail.title">Detalle del Stock</h2>
                <button class="modal-close" onclick="cerrarModal()">×</button>
            </div>
            <div class="detail-grid" id="detail-content"></div>
        </div>
    </div>

    <!-- Modal para ampliar imagen -->
    <!-- Se crea dinámicamente por ampliarImagen() -->

    <!-- Modal Cambiar Contrasena -->
    <div id="change-password-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 data-i18n="changePassword.title">Cambiar Contrasena</h2>
                <button class="modal-close" onclick="hideChangePasswordModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label data-i18n="changePassword.currentPassword">Contrasena Actual</label>
                    <input type="password" id="current-password" class="form-control">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label data-i18n="changePassword.newPassword">Nueva Contrasena</label>
                    <input type="password" id="new-password" class="form-control">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label data-i18n="changePassword.confirmPassword">Confirmar Nueva Contrasena</label>
                    <input type="password" id="confirm-password" class="form-control">
                </div>
                <div id="change-password-error" style="color: #dc3545; font-size: 0.85rem; margin-bottom: 10px; display: none;"></div>
                <div id="change-password-success" style="color: #28a745; font-size: 0.85rem; margin-bottom: 10px; display: none;"></div>
                <button class="btn-primary" onclick="handleVoluntaryPasswordChange()" id="change-password-btn" style="width: 100%;" data-i18n="changePassword.changeButton">Cambiar Contrasena</button>
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js"></script>
    <script src="js/ui-feedback.js"></script>
    <script src="js/sidebar.js?v=20260212"></script>
    <script src="js/page-common.js?v=20260212"></script>
    <script src="js/notifications.js"></script>

    <script>
        const API_URL = PageCommon.API_URL;
        let selectedFile = null;
        let currentUser = null;
        let currentUserRol = null;
        let propuestasHabilitadas = true;
        let whatsappConfig = { habilitado: false, numero: null };
        let carrito = [];
        let csrfToken = null;
        let searchResultsCache = [];

        // ==================== HELPERS ====================
        function t(key, vars) {
            return typeof I18n !== 'undefined' && I18n.t ? I18n.t(key, vars) : key;
        }

        function getEmpresaId() {
            return localStorage.getItem('empresa_id') || '1';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getDecimalPlaces(num) {
            if (!num || num === 0) return 0;
            const numStr = num.toString();
            if (numStr.indexOf('.') === -1) return 0;
            return numStr.split('.')[1].length;
        }

        function formatearCantidadEmpaquetado(cantidad) {
            if (!cantidad || cantidad === 0) return '0';
            const decimales = getDecimalPlaces(cantidad);
            return parseFloat(cantidad).toLocaleString('es-ES', { minimumFractionDigits: decimales, maximumFractionDigits: decimales });
        }

        function redondearADecimales(numero, decimales) {
            if (decimales === 0) return Math.round(numero);
            const factor = Math.pow(10, decimales);
            return Math.round(numero * factor) / factor;
        }

        function getBadgeWithUnit(existencias, unidad) {
            const num = parseFloat(existencias);
            let badgeClass = 'badge-success';
            if (num < 100) badgeClass = 'badge-danger';
            else if (num < 500) badgeClass = 'badge-warning';
            const unidadText = unidad ? ` ${unidad}` : '';
            const numFormatted = num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return `<span class="badge ${badgeClass}">${numFormatted}${unidadText}</span>`;
        }

        async function fetchWithCsrf(url, options = {}) {
            if (['POST', 'PUT', 'DELETE'].includes(options.method)) {
                options.headers = { ...options.headers, 'X-CSRF-Token': csrfToken || localStorage.getItem('csrf_token') };
            }
            options.credentials = 'include';
            return fetch(url, options);
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async function () {
            PageCommon.loadTheme();
            await PageCommon.cargarLogoEmpresa();
            await I18n.init();
            document.getElementById('lang-selector').value = I18n.currentLang;

            const user = await PageCommon.checkAuth();
            if (!user) return;
            currentUser = user;
            currentUserRol = user.rol;

            csrfToken = await PageCommon.obtenerCsrfToken();
            Notifications.init();

            // Cargar configuración en paralelo
            await Promise.all([
                verificarPropuestasHabilitadas(),
                cargarConfigWhatsApp(),
                cargarCarrito()
            ]);

            initDropZone();
        });

        async function verificarPropuestasHabilitadas() {
            try {
                const response = await fetch(`${API_URL}/api/parametros/propuestas-habilitadas?empresa_id=${getEmpresaId()}`);
                const data = await response.json();
                propuestasHabilitadas = data.habilitado;
            } catch (e) { propuestasHabilitadas = true; }
        }

        async function cargarConfigWhatsApp() {
            try {
                const response = await fetch(`${API_URL}/api/consultas/whatsapp-config?empresa_id=${getEmpresaId()}`, { credentials: 'include' });
                const data = await response.json();
                whatsappConfig = { habilitado: data.habilitado || false, numero: data.numero || null };
            } catch (e) { whatsappConfig = { habilitado: false, numero: null }; }
        }

        async function cargarCarrito() {
            try {
                const response = await fetch(`${API_URL}/api/carrito`, { credentials: 'include' });
                if (response.ok) { const data = await response.json(); carrito = data.carrito || []; }
            } catch (e) {}
        }

        // ==================== DROP ZONE ====================
        function initDropZone() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]); });

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
            });

            document.getElementById('preview-remove').addEventListener('click', (e) => { e.stopPropagation(); clearSelectedFile(); });
            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', (e) => e.preventDefault());
        }

        function handleFile(file) {
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) { UIFeedback.toast(t('magicSearch.invalidFormat') || 'Formato no valido. Usa JPG, PNG o WEBP.', 'error'); return; }
            if (file.size > 10 * 1024 * 1024) { UIFeedback.toast(t('magicSearch.fileTooLarge') || 'La imagen excede 10MB.', 'error'); return; }
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('preview-image').style.display = '';
                document.getElementById('preview-placeholder').style.display = 'none';
                document.getElementById('preview-filename').textContent = file.name;
                document.getElementById('preview-filename').style.display = '';
                document.getElementById('preview-remove').style.display = '';
                document.getElementById('preview-panel').classList.add('has-image');
            };
            reader.readAsDataURL(file);
            document.getElementById('btn-search').disabled = false;
        }

        function clearSelectedFile() {
            selectedFile = null;
            document.getElementById('preview-image').src = '';
            document.getElementById('preview-image').style.display = 'none';
            document.getElementById('preview-placeholder').style.display = '';
            document.getElementById('preview-filename').style.display = 'none';
            document.getElementById('preview-remove').style.display = 'none';
            document.getElementById('preview-panel').classList.remove('has-image');
            document.getElementById('file-input').value = '';
            document.getElementById('btn-search').disabled = true;
        }

        // ==================== SEARCH ====================
        async function searchByImage() {
            if (!selectedFile) return;
            const btn = document.getElementById('btn-search');
            btn.classList.add('loading');
            btn.disabled = true;
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('results-empty').style.display = 'none';

            try {
                const base64 = await fileToBase64(selectedFile);
                const response = await fetchWithCsrf(`${API_URL}/api/image-search/search`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64, top_k: 20 })
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    const errorMsg = err.error || err.message || `HTTP ${response.status}`;
                    console.error('Search response error:', response.status, err);
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                console.log('=== SEARCH DEBUG ===', JSON.stringify(data._debug, null, 2));
                console.log('First result:', JSON.stringify(data.results?.[0], null, 2));
                if (data.enrich_error) {
                    console.warn('Enrich error from backend:', data.enrich_error);
                    UIFeedback.toast('Datos de stock no disponibles: ' + data.enrich_error, 'warning');
                }
                renderResults(data.results || []);
            } catch (error) {
                console.error('Error searching:', error);
                UIFeedback.toast(error.message || 'Error al buscar', 'error');
            } finally { btn.classList.remove('loading'); btn.disabled = false; }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ==================== RENDER RESULTS (formato stock-image-card) ====================
        function renderResults(results) {
            const section = document.getElementById('results-section');
            const grid = document.getElementById('results-grid');
            const empty = document.getElementById('results-empty');
            const countEl = document.getElementById('results-count');

            if (!results || results.length === 0) {
                section.style.display = 'none';
                empty.style.display = '';
                searchResultsCache = [];
                return;
            }

            searchResultsCache = results;
            empty.style.display = 'none';
            section.style.display = '';
            countEl.textContent = results.length + ' ' + (t('magicSearch.productsFound') || 'productos encontrados');

            grid.innerHTML = results.map((item, idx) => {
                const similarity = item.similarity || 0;
                const badgeClass = similarity >= 70 ? 'high' : (similarity >= 40 ? 'medium' : 'low');

                return `
                    <div class="stock-image-card" onclick="openStockDetail(${idx})">
                        <div class="stock-image-card-img">
                            <img class="stock-thumb" data-codigo="${escapeHtml(item.codigo || '')}" id="thumb-${idx}"
                                 src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="
                                 alt="${escapeHtml(item.descripcion || '')}" loading="lazy">
                        </div>
                        <div class="stock-image-card-info">
                            <div class="stock-image-card-code">${escapeHtml(item.codigo || '-')}</div>
                            <div class="stock-image-card-desc" title="${escapeHtml(item.descripcion || '')}">${escapeHtml(item.descripcion || '-')}</div>
                            <div class="stock-image-card-details">
                                ${escapeHtml(item.formato || '-')} | ${escapeHtml(item.calidad || '-')} | ${escapeHtml(item.tono || '-')}/${escapeHtml(item.calibre || '-')}${item.unidadescaja ? ` | ${formatearCantidadEmpaquetado(item.unidadescaja)} ${escapeHtml(item.unidad || 'PZ')}/Caj` : ''}${item.pallet ? ` | ${escapeHtml(item.pallet)}` : ''}
                            </div>
                            <div class="stock-image-card-stock">
                                ${getBadgeWithUnit(item.existencias || 0, item.unidad)}
                                <span class="similarity-badge ${badgeClass}">${similarity}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Cargar thumbnails
            loadResultThumbnails(results);
        }

        async function loadResultThumbnails(results) {
            const codigos = results.map(r => r.codigo).filter(Boolean);
            if (codigos.length === 0) return;
            try {
                const response = await fetchWithCsrf(`${API_URL}/api/stocks/thumbnails`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigos, quality: 'grid' })
                });
                if (!response.ok) return;
                const thumbnails = await response.json();
                results.forEach((item, idx) => {
                    const thumb = thumbnails[item.codigo];
                    if (thumb) {
                        const img = document.getElementById('thumb-' + idx);
                        if (img) { img.src = 'data:image/jpeg;base64,' + thumb; img.classList.add('loaded'); }
                    }
                });
            } catch (error) { console.error('Error loading thumbnails:', error); }
        }

        // ==================== DETAIL MODAL (identico a app.js verDetalle) ====================
        async function openStockDetail(idx) {
            const stock = searchResultsCache[idx];
            if (!stock) return;

            window.stockActualDetalle = stock;

            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');

            const existenciasFormatted = parseFloat(stock.existencias || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const similarity = stock.similarity || 0;
            const badgeClass = similarity >= 70 ? 'high' : (similarity >= 40 ? 'medium' : 'low');

            content.innerHTML = `
                <div id="detail-imagenes" class="detail-imagenes">
                    <div class="detail-imagenes-loading">${t('detail.loadingImages')}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 5px;">
                    <div class="detail-stock-badge">
                        ${getBadgeWithUnit(stock.existencias || 0, stock.unidad)}
                    </div>
                    <span class="similarity-badge ${badgeClass}" style="font-size: 0.85rem;">${t('magicSearch.similarity') || 'Similitud'}: ${similarity}%</span>
                </div>
                <div id="detail-ficha-tecnica" class="detail-ficha-tecnica" style="display: none;"></div>
                <div class="detail-actions" style="display: flex; flex-direction: column; gap: 8px; align-items: center; margin: 10px 0;">
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        ${propuestasHabilitadas ? `
                        <button class="btn-icon btn-icon-secondary" style="width: 44px; height: 44px;" title="${t('detail.addToCart')}" onclick="agregarAlCarritoDesdeDetalle()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="9" y1="12" x2="15" y2="12"/></svg>
                        </button>
                        ` : ''}
                        <button class="btn-icon" style="width: 44px; height: 44px; background: #6c757d; color: white;" title="${t('common.close')}" onclick="cerrarModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn-icon" style="width: 44px; height: 44px; background: #2196F3; color: white;" title="${t('inquiry.askQuestion')}" onclick="abrirModalConsulta()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </button>
                        ${whatsappConfig.habilitado ? `
                        <button class="btn-icon" style="width: 44px; height: 44px; background: #25D366; color: white;" title="${t('inquiry.whatsapp')}" onclick="abrirWhatsApp()">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </button>
                        ` : ''}
                    </div>
                </div>
                ${stock.unidadescaja || stock.cajaspallet || stock.pesocaja || stock.pesopallet ? `
                <div class="detail-packaging-section">
                    <div class="detail-packaging-title">${t('detail.packaging')}</div>
                    <div class="detail-packaging-grid">
                        ${stock.unidadescaja ? `<div class="detail-packaging-item"><div class="detail-packaging-icon">📦</div><div class="detail-packaging-info"><div class="detail-packaging-label">${t('detail.unitsPerBox')}</div><div class="detail-packaging-value">${formatearCantidadEmpaquetado(stock.unidadescaja)} ${stock.unidad || ''}</div></div></div>` : ''}
                        ${stock.cajaspallet ? `<div class="detail-packaging-item"><div class="detail-packaging-icon">🏗️</div><div class="detail-packaging-info"><div class="detail-packaging-label">${t('detail.boxesPerPallet')}</div><div class="detail-packaging-value">${formatearCantidadEmpaquetado(stock.cajaspallet)}</div></div></div>` : ''}
                        ${stock.unidadescaja && stock.cajaspallet ? `<div class="detail-packaging-item"><div class="detail-packaging-icon">📊</div><div class="detail-packaging-info"><div class="detail-packaging-label">${t('detail.unitsPerPallet')}</div><div class="detail-packaging-value">${(() => { const dec = getDecimalPlaces(stock.unidadescaja); const total = redondearADecimales(stock.unidadescaja * stock.cajaspallet, dec); return parseFloat(total).toLocaleString('es-ES', { minimumFractionDigits: dec, maximumFractionDigits: dec }); })()} ${stock.unidad || ''}</div></div></div>` : ''}
                        ${stock.pesocaja ? `<div class="detail-packaging-item"><div class="detail-packaging-icon">⚖️</div><div class="detail-packaging-info"><div class="detail-packaging-label">${t('detail.weightPerBox')}</div><div class="detail-packaging-value">${stock.pesocaja.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</div></div></div>` : ''}
                        ${stock.pesopallet ? `<div class="detail-packaging-item"><div class="detail-packaging-icon">🏋️</div><div class="detail-packaging-info"><div class="detail-packaging-label">${t('detail.weightPerPallet')}</div><div class="detail-packaging-value">${stock.pesopallet.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</div></div></div>` : ''}
                    </div>
                </div>
                ` : ''}
                <div class="detail-groupbox">
                    <div class="detail-groupbox-title">${t('detail.details')}</div>
                    <div class="detail-groupbox-content">
                        <div class="detail-item"><span class="detail-label">${t('detail.code')}:</span><span class="detail-value">${escapeHtml(stock.codigo || '-')}</span></div>
                        ${stock.ean13 ? `<div class="detail-item"><span class="detail-label">${t('detail.ean13')}:</span><span class="detail-value">${escapeHtml(stock.ean13)}</span></div>` : ''}
                        <div class="detail-item"><span class="detail-label">${t('detail.description')}:</span><span class="detail-value">${escapeHtml(stock.descripcion || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.format')}:</span><span class="detail-value">${escapeHtml(stock.formato || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.model')}:</span><span class="detail-value">${escapeHtml(stock.serie || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.color')}:</span><span class="detail-value">${escapeHtml(stock.color || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.quality')}:</span><span class="detail-value">${escapeHtml(stock.calidad || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.tone')}:</span><span class="detail-value">${escapeHtml(stock.tono || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.caliber')}:</span><span class="detail-value">${escapeHtml(stock.calibre || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.pallet')}:</span><span class="detail-value">${escapeHtml(stock.pallet || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.box')}:</span><span class="detail-value">${escapeHtml(stock.caja || '-')}</span></div>
                        <div class="detail-item"><span class="detail-label">${t('detail.stock')}:</span><span class="detail-value"><strong>${existenciasFormatted} ${escapeHtml(stock.unidad || '')}</strong></span></div>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';

            // Cargar imagenes
            try {
                const response = await fetch(`${API_URL}/api/stocks/${encodeURIComponent(stock.codigo)}/imagenes`, { credentials: 'include' });
                const imagenesContainer = document.getElementById('detail-imagenes');
                if (response.ok) {
                    const imagenes = await response.json();
                    if (imagenes.length > 0) {
                        let html = `<div class="detail-label" style="width:100%; margin-bottom: 10px;">${t('detail.images')}:</div><div class="detail-imagenes-grid">`;
                        imagenes.forEach((img, i) => { html += `<div class="detail-imagen-item" onclick="ampliarImagen('${img.imagen}')"><img src="data:image/jpeg;base64,${img.imagen}" alt="Imagen ${i+1}"></div>`; });
                        html += '</div>';
                        imagenesContainer.innerHTML = html;
                    } else { imagenesContainer.innerHTML = `<div class="detail-no-imagenes">${t('detail.noImages')}</div>`; }
                } else { imagenesContainer.innerHTML = `<div class="detail-no-imagenes">${t('detail.noImages')}</div>`; }
            } catch (e) { document.getElementById('detail-imagenes').innerHTML = `<div class="detail-no-imagenes">${t('detail.errorLoadingImages')}</div>`; }

            // Cargar ficha tecnica
            try {
                const fichaTecnicaParams = stock.tono ? `?tono=${encodeURIComponent(stock.tono)}` : '';
                const ftResponse = await fetch(`${API_URL}/api/stocks/${encodeURIComponent(stock.codigo)}/ficha-tecnica${fichaTecnicaParams}`, { credentials: 'include' });
                const fichaContainer = document.getElementById('detail-ficha-tecnica');
                if (ftResponse.ok) {
                    const ftData = await ftResponse.json();
                    if (ftData && ftData.ficha) {
                        fichaContainer.style.display = 'block';
                        fichaContainer.innerHTML = `<div class="ficha-tecnica-block" style="border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 15px;"><div class="detail-label" style="margin-bottom: 12px;">${t('detail.technicalSheet')}:</div><a href="data:application/pdf;base64,${ftData.ficha}" download="ficha_tecnica_${stock.codigo}.pdf" class="btn-download-ficha" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #FF5722; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>${t('detail.downloadPdf')}</a></div>`;
                    }
                }
            } catch (e) {}
        }

        function cerrarModal() { document.getElementById('detail-modal').style.display = 'none'; }

        document.getElementById('detail-modal').addEventListener('click', function(e) { if (e.target === this) cerrarModal(); });
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') cerrarModal(); });

        // ==================== AMPLIAR IMAGEN ====================
        function ampliarImagen(base64) {
            const modalImg = document.createElement('div');
            modalImg.className = 'imagen-modal-overlay';
            modalImg.innerHTML = `
                <div class="imagen-modal-content" onclick="event.stopPropagation()">
                    <img src="data:image/jpeg;base64,${base64}" alt="Imagen ampliada">
                    <button class="imagen-modal-close" onclick="this.parentElement.parentElement.remove()">&#10005;</button>
                </div>
            `;
            modalImg.onclick = () => modalImg.remove();
            document.body.appendChild(modalImg);
        }

        // ==================== MODAL DE CANTIDAD PARA CARRITO ====================
        function mostrarModalCantidad(stock) {
            const existenciasFormatted = parseFloat(stock.existencias).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const decimalesEmpaquetado = getDecimalPlaces(stock.unidadescaja || 0);
            const unidadesCajaFormatted = stock.unidadescaja ? formatearCantidadEmpaquetado(stock.unidadescaja) : '0';
            let unidadesPallet = 0;
            if (stock.cajaspallet && stock.unidadescaja) {
                unidadesPallet = stock.cajaspallet * stock.unidadescaja;
                unidadesPallet = redondearADecimales(unidadesPallet, decimalesEmpaquetado);
            }
            const unidadesPalletFormatted = unidadesPallet > 0 ? formatearCantidadEmpaquetado(unidadesPallet) : '0';

            const modalHTML = `
                <div class="quantity-modal-overlay" id="quantity-modal-overlay">
                    <div class="quantity-modal">
                        <div class="quantity-modal-header">
                            <h3>${t('cart.addToCart')}</h3>
                            <button class="quantity-modal-close" onclick="cerrarModalCantidad()">&#10005;</button>
                        </div>
                        <div class="quantity-modal-body">
                            <div class="quantity-product-info">
                                <div class="quantity-product-title">${stock.descripcion}</div>
                                <div class="quantity-product-details">
                                    <span class="quantity-detail-item"><strong>${t('table.code')}:</strong> ${stock.codigo}</span>
                                    ${stock.formato ? `<span class="quantity-detail-item"><strong>${t('table.format')}:</strong> ${stock.formato}</span>` : ''}
                                    ${stock.calidad ? `<span class="quantity-detail-item"><strong>${t('table.quality')}:</strong> ${stock.calidad}</span>` : ''}
                                    ${stock.tono ? `<span class="quantity-detail-item"><strong>${t('table.tone')}:</strong> ${stock.tono}</span>` : ''}
                                    ${stock.calibre ? `<span class="quantity-detail-item"><strong>${t('table.caliber')}:</strong> ${stock.calibre}</span>` : ''}
                                </div>
                                <div class="quantity-stock-info">
                                    <span class="quantity-stock-label">${t('table.stock')}:</span>
                                    <span class="quantity-stock-value">${existenciasFormatted} ${stock.unidad || ''}</span>
                                </div>
                            </div>
                            <div class="quantity-input-section">
                                <label class="quantity-label">${t('cart.quantity')}:</label>
                                <div class="quantity-control">
                                    <button class="quantity-btn quantity-btn-minus" onclick="cambiarCantidad(-1)">&#8722;</button>
                                    <input type="number" id="quantity-input" class="quantity-input" value="0" min="0" max="${stock.existencias}" step="1">
                                    <button class="quantity-btn quantity-btn-plus" onclick="cambiarCantidad(1)">+</button>
                                </div>
                                <div class="quantity-quick-buttons">
                                    ${stock.unidadescaja && stock.unidadescaja > 0 ? `
                                        <div class="quantity-package-group">
                                            <span class="quantity-package-label">${t('cart.box')}: ${unidadesCajaFormatted} ${stock.unidad || ''}</span>
                                            <div class="quantity-package-controls">
                                                <button class="quantity-package-btn" onclick="cambiarCantidadPorUnidad(-${stock.unidadescaja})" title="Restar 1 caja">
                                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                                </button>
                                                <button class="quantity-package-btn quantity-package-btn-primary" onclick="cambiarCantidadPorUnidad(${stock.unidadescaja})" title="Agregar 1 caja">
                                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${unidadesPallet > 0 ? `
                                        <div class="quantity-package-group">
                                            <span class="quantity-package-label">${t('cart.pallet')}: ${unidadesPalletFormatted} ${stock.unidad || ''}</span>
                                            <div class="quantity-package-controls">
                                                <button class="quantity-package-btn" onclick="cambiarCantidadPorUnidad(-${unidadesPallet})" title="Restar 1 pallet">
                                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                                </button>
                                                <button class="quantity-package-btn quantity-package-btn-primary" onclick="cambiarCantidadPorUnidad(${unidadesPallet})" title="Agregar 1 pallet">
                                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="quantity-modal-footer">
                            <button class="quantity-btn-cancel" onclick="cerrarModalCantidad()" title="${t('common.cancel')}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                            <button class="quantity-btn-confirm" onclick="confirmarAgregarAlCarrito()" title="${t('cart.addToCart')}">
                                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="9" y1="12" x2="15" y2="12"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            window.stockTemporal = stock;
            window.stockTemporal.decimalesEmpaquetado = getDecimalPlaces(stock.unidadescaja || 0);
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setTimeout(() => { document.getElementById('quantity-input').select(); }, 100);
        }

        function cambiarCantidad(delta) {
            const input = document.getElementById('quantity-input');
            const maxStock = parseFloat(input.max);
            let currentValue = parseFloat(input.value) || 0;
            currentValue += delta;
            const decimalesPrecision = window.stockTemporal?.decimalesEmpaquetado || 0;
            currentValue = redondearADecimales(currentValue, decimalesPrecision);
            if (currentValue < 0) currentValue = 0;
            if (currentValue > maxStock) currentValue = maxStock;
            input.value = currentValue;
            input.focus();
        }

        function cambiarCantidadPorUnidad(unidades) {
            const input = document.getElementById('quantity-input');
            const maxStock = parseFloat(input.max);
            let currentValue = parseFloat(input.value) || 0;
            let newValue = currentValue + unidades;
            const decimalesPrecision = window.stockTemporal?.decimalesEmpaquetado || 0;
            newValue = redondearADecimales(newValue, decimalesPrecision);
            if (newValue < 0) newValue = 0;
            if (newValue > maxStock) {
                UIFeedback.toast(t('cart.exceedsStock', { requested: newValue, available: maxStock }) || 'Cantidad excede stock disponible', 'warning');
                newValue = maxStock;
            }
            input.value = newValue;
            input.focus();
        }

        function cerrarModalCantidad() {
            const modal = document.getElementById('quantity-modal-overlay');
            if (modal) modal.remove();
            window.stockTemporal = null;
        }

        async function confirmarAgregarAlCarrito() {
            const input = document.getElementById('quantity-input');
            const cantidadNum = parseFloat(input.value);
            const stock = window.stockTemporal;

            if (!stock) { UIFeedback.toast('Error: No hay producto seleccionado', 'error'); return; }
            if (isNaN(cantidadNum) || cantidadNum <= 0) { UIFeedback.toast(t('cart.invalidQuantity') || 'Cantidad no valida', 'warning'); input.focus(); return; }
            if (cantidadNum > stock.existencias) { UIFeedback.toast(t('cart.exceedsStock', { requested: cantidadNum, available: stock.existencias }) || 'Excede stock', 'warning'); input.focus(); return; }

            cerrarModalCantidad();

            try {
                const response = await fetchWithCsrf(`${API_URL}/api/carrito/add`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo: stock.codigo,
                        descripcion: stock.descripcion,
                        formato: stock.formato,
                        calidad: stock.calidad,
                        color: stock.color,
                        tono: stock.tono,
                        calibre: stock.calibre,
                        pallet: stock.pallet,
                        caja: stock.caja,
                        existencias: stock.existencias,
                        unidad: stock.unidad,
                        cantidad_solicitada: cantidadNum
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    carrito = data.carrito;
                    cerrarModal();
                    UIFeedback.toast(t('cart.addedSuccess', { quantity: cantidadNum, unit: stock.unidad || '' }) || `Agregado: ${cantidadNum}`, 'success');
                } else {
                    UIFeedback.toast(t('cart.addError') || 'Error al agregar', 'error');
                }
            } catch (error) {
                console.error('Error al agregar al carrito:', error);
                UIFeedback.toast(t('cart.addError') || 'Error al agregar', 'error');
            }
        }

        function agregarAlCarritoDesdeDetalle() {
            if (window.stockActualDetalle) {
                mostrarModalCantidad(window.stockActualDetalle);
            }
        }

        // ==================== CONSULTAS SOBRE PRODUCTOS ====================
        function abrirModalConsulta() {
            const stock = window.stockActualDetalle;
            if (!stock) return;

            let modal = document.getElementById('inquiry-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'inquiry-modal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }

            const userName = currentUser?.full_name || '';
            const userEmail = currentUser?.email || '';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%); padding: 20px; border-radius: 8px 8px 0 0;">
                        <h2 style="margin: 0; color: white; font-size: 1.3em;">${t('inquiry.title')}</h2>
                        <button class="modal-close" onclick="cerrarModalConsulta()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; position: absolute; right: 15px; top: 15px;">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <p style="color: #666; margin-bottom: 15px;">${t('inquiry.subtitle')}</p>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                            <strong>${escapeHtml(stock.codigo)}</strong> - ${escapeHtml(stock.descripcion || '')}
                            <br><small style="color: #666;">${escapeHtml(stock.formato || '')} | ${escapeHtml(stock.calidad || '')} | ${escapeHtml(stock.tono || '')} | ${escapeHtml(stock.calibre || '')}</small>
                        </div>
                        <form id="inquiry-form" onsubmit="enviarConsulta(event)">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">${t('inquiry.name')} *</label>
                                <input type="text" id="inquiry-name" value="${escapeHtml(userName)}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">${t('inquiry.email')} *</label>
                                <input type="email" id="inquiry-email" value="${escapeHtml(userEmail)}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">${t('inquiry.phone')}</label>
                                <input type="tel" id="inquiry-phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">${t('inquiry.message')} *</label>
                                <textarea id="inquiry-message" rows="4" required placeholder="${t('inquiry.messagePlaceholder')}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="cerrarModalConsulta()" style="padding: 12px 24px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">${t('common.cancel')}</button>
                                <button type="submit" id="inquiry-submit-btn" style="padding: 12px 24px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer;">${t('inquiry.send')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function cerrarModalConsulta() {
            const modal = document.getElementById('inquiry-modal');
            if (modal) modal.style.display = 'none';
        }

        async function enviarConsulta(event) {
            event.preventDefault();
            const stock = window.stockActualDetalle;
            if (!stock) return;

            const nombre = document.getElementById('inquiry-name').value.trim();
            const email = document.getElementById('inquiry-email').value.trim();
            const telefono = document.getElementById('inquiry-phone').value.trim();
            const mensaje = document.getElementById('inquiry-message').value.trim();

            if (!nombre || !email || !mensaje) { UIFeedback.toast(t('inquiry.requiredFields'), 'warning'); return; }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) { UIFeedback.toast(t('inquiry.invalidEmail'), 'warning'); return; }

            const submitBtn = document.getElementById('inquiry-submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = t('inquiry.sending');
            submitBtn.disabled = true;

            try {
                const response = await fetchWithCsrf(`${API_URL}/api/consultas?empresa_id=${getEmpresaId()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        codigo_producto: stock.codigo, descripcion_producto: stock.descripcion,
                        formato: stock.formato, calidad: stock.calidad, color: stock.color,
                        tono: stock.tono, calibre: stock.calibre,
                        nombre_cliente: nombre, email_cliente: email, telefono_cliente: telefono, mensaje
                    })
                });
                const data = await response.json();
                if (data.success) { UIFeedback.toast(t('inquiry.success'), 'success'); cerrarModalConsulta(); cerrarModal(); }
                else { UIFeedback.toast(t('inquiry.error') + ': ' + (data.error || ''), 'error'); }
            } catch (error) {
                console.error('Error al enviar consulta:', error);
                UIFeedback.toast(t('inquiry.error'), 'error');
            } finally { submitBtn.textContent = originalText; submitBtn.disabled = false; }
        }

        function abrirWhatsApp() {
            const stock = window.stockActualDetalle;
            if (!stock || !whatsappConfig.numero) return;
            const mensaje = t('inquiry.whatsappMessage', {
                code: stock.codigo, description: stock.descripcion || '-',
                format: stock.formato || '-', quality: stock.calidad || '-',
                tone: stock.tono || '-', caliber: stock.calibre || '-'
            });
            window.open(`https://wa.me/${whatsappConfig.numero}?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        // Exponer funciones para HTML dinamico
        window.abrirModalConsulta = abrirModalConsulta;
        window.cerrarModalConsulta = cerrarModalConsulta;
        window.enviarConsulta = enviarConsulta;
        window.abrirWhatsApp = abrirWhatsApp;
        window.ampliarImagen = ampliarImagen;
        window.agregarAlCarritoDesdeDetalle = agregarAlCarritoDesdeDetalle;
        window.mostrarModalCantidad = mostrarModalCantidad;
        window.cambiarCantidad = cambiarCantidad;
        window.cambiarCantidadPorUnidad = cambiarCantidadPorUnidad;
        window.cerrarModalCantidad = cerrarModalCantidad;
        window.confirmarAgregarAlCarrito = confirmarAgregarAlCarrito;
        window.cerrarModal = cerrarModal;
        window.openStockDetail = openStockDetail;
        window.searchByImage = searchByImage;
    </script>
</body>
</html>
