<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas de Productos - Administracion</title>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Cargar tema guardado inmediatamente para evitar flash
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            const colorTheme = localStorage.getItem('colorTheme') || 'rubi';
            document.documentElement.setAttribute('data-color-theme', colorTheme);
            // Crear favicon desde localStorage (sin link est√°tico para evitar flash)
            const faviconUrl = localStorage.getItem('faviconUrl');
            if (faviconUrl) {
                const link = document.createElement('link');
                link.rel = 'icon';
                link.href = faviconUrl;
                document.head.appendChild(link);
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header de la pagina -->
        <div class="page-header">
            <div class="logo-section">
                <a href="#" onclick="goBack(); return false;" style="display: flex; align-items: center;">
                    <img src="" alt="Logo" class="logo" style="cursor: pointer; visibility: hidden;">
                </a>
                <h1 data-i18n="inquiries.allTitle">Consultas de Productos</h1>
                <span class="pending-badge" id="pending-count" style="display: none;">0 pendientes</span>
            </div>
            <div class="header-actions">
                <div class="lang-selector-wrapper">
                    <select id="lang-selector" class="lang-selector lang-selector-header" onchange="I18n.setLanguage(this.value)">
                        <option value="es">ES</option>
                        <option value="en">EN</option>
                        <option value="fr">FR</option>
                    </select>
                </div>
                <button class="back-btn" onclick="goBack()">
                    <span data-i18n="common.back">Volver</span>
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-container" style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="inquiries.filterStatus">Estado</label>
                    <select id="filter-estado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="" data-i18n="inquiries.allStatuses">Todos los estados</option>
                        <option value="pendiente" data-i18n="inquiries.statusPending">Pendiente</option>
                        <option value="respondida" data-i18n="inquiries.statusAnswered">Respondida</option>
                        <option value="cerrada" data-i18n="inquiries.statusClosed">Cerrada</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterDateFrom">Desde</label>
                    <input type="date" id="filter-fecha-desde" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="filter-group">
                    <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px;" data-i18n="proposals.filterDateTo">Hasta</label>
                    <input type="date" id="filter-fecha-hasta" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                <div class="filter-actions" style="display: flex; gap: 10px;">
                    <button onclick="applyFilters()" class="btn-primary" style="padding: 10px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" data-i18n="common.search">Buscar</button>
                    <button onclick="clearFilters()" class="btn-secondary" style="padding: 10px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" data-i18n="common.clear">Limpiar</button>
                </div>
            </div>
        </div>

        <!-- Contenedor principal -->
        <div class="inquiries-container">
            <div class="inquiries-content">
                <!-- Loading state -->
                <div class="inquiries-loading" id="inquiries-loading">
                    <div class="spinner"></div>
                    <p data-i18n="inquiries.loading">Cargando consultas...</p>
                </div>

                <!-- Empty state -->
                <div class="inquiries-empty" id="inquiries-empty" style="display: none;">
                    <div class="inquiries-empty-icon">üí¨</div>
                    <h3 data-i18n="inquiries.noInquiries">No hay consultas</h3>
                </div>

                <!-- Table view (desktop) -->
                <div class="inquiries-table-wrapper" id="inquiries-table-wrapper" style="display: none;">
                    <table class="inquiries-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th data-i18n="inquiries.product">Producto</th>
                                <th data-i18n="inquiries.client">Cliente</th>
                                <th data-i18n="proposals.date">Fecha</th>
                                <th data-i18n="proposals.status">Estado</th>
                                <th data-i18n="users.actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inquiries-table-body">
                        </tbody>
                    </table>
                </div>

                <!-- Cards view (mobile) -->
                <div class="inquiries-cards" id="inquiries-cards">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalle -->
    <div id="inquiry-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="inquiries.viewDetail">Detalle de Consulta</h2>
                <button class="modal-close" onclick="closeInquiryModal()">&times;</button>
            </div>
            <div class="inquiry-detail-content" id="inquiry-detail-content">
            </div>
        </div>
    </div>

    <script src="js/i18n/i18n.js"></script>
    <script>
        // ==================== CONFIGURACION ====================
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
        const API_URL = isLocalhost ? `${protocol}//${hostname}:5000` : `${protocol}//${hostname}`;

        // ==================== LOGO DIN√ÅMICO POR EMPRESA ====================
        function applyColorTheme(tema) {
            const validThemes = ['rubi', 'zafiro', 'esmeralda', 'amatista', 'ambar', 'grafito'];
            if (!validThemes.includes(tema)) tema = 'rubi';
            document.documentElement.setAttribute('data-color-theme', tema);
            localStorage.setItem('colorTheme', tema);
        }

        async function cargarLogoEmpresa() {
            // Usar connection (empresa_cli_id) para endpoints de logo
            const connection = localStorage.getItem('connection');
            if (!connection) {
                console.warn('No hay connection en localStorage, usando valores por defecto');
                applyColorTheme('rubi');
                return;
            }
            const logoElements = document.querySelectorAll('.logo');
            try {
                const configResponse = await fetch(`${API_URL}/api/empresa/${connection}/config`);
                const config = await configResponse.json();
                applyColorTheme(config.tema || 'rubi');
                const invertirFilter = config.invertir_logo ? 'brightness(0) invert(1)' : 'none';
                if (config.tiene_logo) {
                    const logoUrl = `${API_URL}/api/empresa/${connection}/logo?t=${Date.now()}`;
                    logoElements.forEach(el => {
                        el.src = logoUrl;
                        el.style.filter = invertirFilter;
                        el.style.visibility = 'visible';
                    });
                } else {
                    logoElements.forEach(el => {
                        el.src = 'assets/logo.svg';
                        el.style.filter = 'brightness(0) invert(1)';
                        el.style.visibility = 'visible';
                    });
                }
            } catch (error) {
                console.log('Error al cargar logo:', error);
                applyColorTheme('rubi');
                logoElements.forEach(el => {
                    el.src = 'assets/logo.svg';
                    el.style.filter = 'brightness(0) invert(1)';
                    el.style.visibility = 'visible';
                });
            }
        }

        let allInquiries = [];
        let filteredInquiries = [];

        // ==================== INICIALIZACION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar logo de empresa (usa connection de localStorage)
            await cargarLogoEmpresa();

            // Inicializar i18n
            await I18n.init();

            // Actualizar selector de idioma
            const langSelector = document.getElementById('lang-selector');
            if (langSelector) {
                langSelector.value = I18n.currentLang;
            }

            // Verificar autenticacion y permisos de admin
            await checkAuth();

            // Cargar consultas
            await loadInquiries();

            // Cargar contador de pendientes
            await loadPendingCount();
        });

        // ==================== AUTENTICACION ====================
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/api/current-user`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = await response.json();

                // Verificar que sea administrador o superusuario
                if (user.rol !== 'administrador' && user.rol !== 'superusuario') {
                    alert('No tienes permisos para acceder a esta pagina');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = 'login.html';
            }
        }

        // ==================== CARGAR CONSULTAS ====================
        async function loadInquiries() {
            const loadingEl = document.getElementById('inquiries-loading');
            const emptyEl = document.getElementById('inquiries-empty');
            const tableWrapper = document.getElementById('inquiries-table-wrapper');

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/consultas?empresa_id=${empresaId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        alert('No tienes permisos para ver las consultas');
                        window.location.href = 'index.html';
                        return;
                    }
                    throw new Error('Error loading inquiries');
                }

                const data = await response.json();
                allInquiries = data.consultas || [];
                filteredInquiries = [...allInquiries];

                loadingEl.style.display = 'none';

                if (allInquiries.length === 0) {
                    emptyEl.style.display = 'block';
                    tableWrapper.style.display = 'none';
                } else {
                    emptyEl.style.display = 'none';
                    tableWrapper.style.display = 'block';
                    renderInquiries();
                }
            } catch (error) {
                console.error('Error loading inquiries:', error);
                loadingEl.innerHTML = `<p style="color: #dc3545;">Error al cargar las consultas</p>`;
            }
        }

        // ==================== CARGAR PENDIENTES ====================
        async function loadPendingCount() {
            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/consultas/pendientes/count?empresa_id=${empresaId}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('pending-count');
                    if (data.count > 0) {
                        badge.textContent = `${data.count} ${t('inquiries.pending')}`;
                        badge.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error loading pending count:', error);
            }
        }

        // ==================== FILTRAR ====================
        function applyFilters() {
            const estado = document.getElementById('filter-estado').value;
            const fechaDesde = document.getElementById('filter-fecha-desde').value;
            const fechaHasta = document.getElementById('filter-fecha-hasta').value;

            filteredInquiries = allInquiries.filter(inquiry => {
                if (estado && inquiry.estado !== estado) {
                    return false;
                }

                if (fechaDesde) {
                    const inquiryDate = new Date(inquiry.fecha_creacion);
                    const filterDate = new Date(fechaDesde);
                    if (inquiryDate < filterDate) {
                        return false;
                    }
                }

                if (fechaHasta) {
                    const inquiryDate = new Date(inquiry.fecha_creacion);
                    const filterDate = new Date(fechaHasta);
                    filterDate.setHours(23, 59, 59, 999);
                    if (inquiryDate > filterDate) {
                        return false;
                    }
                }

                return true;
            });

            renderInquiries();
        }

        function clearFilters() {
            document.getElementById('filter-estado').value = '';
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';

            filteredInquiries = [...allInquiries];
            renderInquiries();
        }

        // ==================== RENDERIZAR ====================
        function renderInquiries() {
            const tableBody = document.getElementById('inquiries-table-body');
            const cardsEl = document.getElementById('inquiries-cards');
            const emptyEl = document.getElementById('inquiries-empty');
            const tableWrapper = document.getElementById('inquiries-table-wrapper');

            if (filteredInquiries.length === 0) {
                emptyEl.style.display = 'block';
                tableWrapper.style.display = 'none';
                cardsEl.innerHTML = '';
                return;
            }

            emptyEl.style.display = 'none';
            tableWrapper.style.display = 'block';

            // Renderizar tabla
            tableBody.innerHTML = filteredInquiries.map(inquiry => `
                <tr>
                    <td><strong>#${inquiry.id}</strong></td>
                    <td>
                        <span class="product-badge">${inquiry.codigo_producto}</span>
                        <br><small style="color: #666;">${truncate(inquiry.descripcion_producto, 30)}</small>
                    </td>
                    <td>
                        <div class="client-info">
                            <div class="name">${inquiry.nombre_cliente}</div>
                            <div class="email">${inquiry.email_cliente}</div>
                        </div>
                    </td>
                    <td>${formatDate(inquiry.fecha_creacion)}</td>
                    <td>${getStatusBadge(inquiry.estado)}</td>
                    <td>
                        <div class="status-actions">
                            <button class="btn-view-details" onclick="viewInquiryDetails(${inquiry.id})">
                                ${t('proposals.viewDetails')}
                            </button>
                            ${inquiry.estado === 'pendiente' ? `
                                <button class="btn-status btn-status-respond" onclick="viewInquiryDetails(${inquiry.id})">
                                    ${t('inquiries.respond')}
                                </button>
                            ` : ''}
                            ${inquiry.estado !== 'cerrada' ? `
                                <button class="btn-status btn-status-close" onclick="changeStatus(${inquiry.id}, 'cerrada')">
                                    ${t('inquiries.close')}
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            // Renderizar cards (movil)
            cardsEl.innerHTML = filteredInquiries.map(inquiry => `
                <div class="inquiry-card">
                    <div class="inquiry-card-header">
                        <span class="inquiry-card-product">${inquiry.codigo_producto}</span>
                        ${getStatusBadge(inquiry.estado)}
                    </div>
                    <div class="inquiry-card-client">
                        <span class="name">${inquiry.nombre_cliente}</span>
                        <br><small>${inquiry.email_cliente}</small>
                    </div>
                    <div class="inquiry-card-date">${formatDate(inquiry.fecha_creacion)}</div>
                    <div class="inquiry-card-message">${inquiry.mensaje}</div>
                    <div class="inquiry-card-actions">
                        <button class="btn-view-details" onclick="viewInquiryDetails(${inquiry.id})" style="width: 100%;">
                            ${t('proposals.viewDetails')}
                        </button>
                        ${inquiry.estado === 'pendiente' ? `
                            <button class="btn-status btn-status-respond" onclick="viewInquiryDetails(${inquiry.id})" style="width: 100%;">
                                ${t('inquiries.respond')}
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ==================== VER DETALLE ====================
        async function viewInquiryDetails(inquiryId) {
            const modal = document.getElementById('inquiry-detail-modal');
            const content = document.getElementById('inquiry-detail-content');

            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="inquiries-loading">
                    <div class="spinner"></div>
                    <p>${t('common.loading')}</p>
                </div>
            `;

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/consultas/${inquiryId}?empresa_id=${empresaId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Error loading inquiry details');
                }

                const data = await response.json();
                const inquiry = data.consulta;

                content.innerHTML = `
                    <div class="inquiry-section">
                        <h4>üì¶ ${t('inquiries.product')}</h4>
                        <div class="inquiry-section-grid">
                            <div class="inquiry-field">
                                <label>${t('table.code')}</label>
                                <span style="color: var(--primary); font-weight: 600;">${inquiry.codigo_producto}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('table.description')}</label>
                                <span>${inquiry.descripcion_producto || '-'}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('table.format')}</label>
                                <span>${inquiry.formato || '-'}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('table.quality')}</label>
                                <span>${inquiry.calidad || '-'}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('table.tone')}</label>
                                <span>${inquiry.tono || '-'}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('table.caliber')}</label>
                                <span>${inquiry.calibre || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="inquiry-section">
                        <h4>üë§ ${t('inquiries.client')}</h4>
                        <div class="inquiry-section-grid">
                            <div class="inquiry-field">
                                <label>${t('inquiry.name')}</label>
                                <span>${inquiry.nombre_cliente}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('inquiry.email')}</label>
                                <span><a href="mailto:${inquiry.email_cliente}">${inquiry.email_cliente}</a></span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('inquiry.phone')}</label>
                                <span>${inquiry.telefono_cliente || '-'}</span>
                            </div>
                            <div class="inquiry-field">
                                <label>${t('proposals.status')}</label>
                                <span>${getStatusBadge(inquiry.estado)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="inquiry-message">
                        <h4>üí¨ ${t('inquiries.message')}</h4>
                        <p>${inquiry.mensaje}</p>
                    </div>

                    ${inquiry.respuesta ? `
                        <div class="inquiry-response">
                            <h4>‚úÖ ${t('inquiries.response')}</h4>
                            <p>${inquiry.respuesta}</p>
                            <div class="meta">
                                ${inquiry.respondido_por_nombre ? `Por: ${inquiry.respondido_por_nombre}` : ''}
                                ${inquiry.fecha_respuesta ? ` - ${formatDate(inquiry.fecha_respuesta)}` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${inquiry.estado === 'pendiente' ? `
                        <div class="response-form">
                            <h4>‚úçÔ∏è ${t('inquiries.writeResponse')}</h4>
                            <textarea id="response-text" placeholder="${t('inquiries.responsePlaceholder')}"></textarea>
                            <div class="form-actions">
                                <button class="btn-send" onclick="sendResponse(${inquiry.id})">
                                    üìß ${t('inquiries.sendResponse')}
                                </button>
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error loading inquiry details:', error);
                content.innerHTML = `<p style="color: #dc3545; text-align: center;">Error al cargar los detalles</p>`;
            }
        }

        // ==================== ENVIAR RESPUESTA ====================
        async function sendResponse(inquiryId) {
            const responseText = document.getElementById('response-text').value.trim();

            if (!responseText) {
                alert(t('inquiries.responseRequired'));
                return;
            }

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/consultas/${inquiryId}/responder?empresa_id=${empresaId}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        respuesta: responseText,
                        enviar_email: true
                    })
                });

                if (!response.ok) {
                    throw new Error('Error sending response');
                }

                alert(t('inquiries.responseSent'));
                closeInquiryModal();
                await loadInquiries();
                await loadPendingCount();
            } catch (error) {
                console.error('Error sending response:', error);
                alert(t('inquiries.responseError'));
            }
        }

        // ==================== CAMBIAR ESTADO ====================
        async function changeStatus(inquiryId, newStatus) {
            if (!confirm(`${t('inquiries.confirmClose')}`)) {
                return;
            }

            try {
                const empresaId = localStorage.getItem('empresa_id');
                const response = await fetch(`${API_URL}/api/consultas/${inquiryId}/estado?empresa_id=${empresaId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Error changing status');
                }

                // Actualizar en la lista local
                const index = allInquiries.findIndex(i => i.id === inquiryId);
                if (index !== -1) {
                    allInquiries[index].estado = newStatus;
                }

                const filteredIndex = filteredInquiries.findIndex(i => i.id === inquiryId);
                if (filteredIndex !== -1) {
                    filteredInquiries[filteredIndex].estado = newStatus;
                }

                renderInquiries();
                await loadPendingCount();
            } catch (error) {
                console.error('Error changing status:', error);
                alert('Error al cambiar el estado');
            }
        }

        // ==================== CERRAR MODAL ====================
        function closeInquiryModal() {
            document.getElementById('inquiry-detail-modal').style.display = 'none';
        }

        // ==================== UTILIDADES ====================
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function truncate(str, length) {
            if (!str) return '-';
            return str.length > length ? str.substring(0, length) + '...' : str;
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pendiente': { class: 'status-pendiente', key: 'inquiries.statusPending' },
                'respondida': { class: 'status-respondida', key: 'inquiries.statusAnswered' },
                'cerrada': { class: 'status-cerrada', key: 'inquiries.statusClosed' }
            };

            const statusInfo = statusMap[status] || { class: 'status-pendiente', key: 'inquiries.statusPending' };
            return `<span class="status-badge ${statusInfo.class}">${t(statusInfo.key)}</span>`;
        }

        function goBack() {
            const empresaId = localStorage.getItem('empresa_id');
            window.location.href = `index.html?empresa=${empresaId}`;
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('inquiry-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInquiryModal();
            }
        });

        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeInquiryModal();
            }
        });
    </script>
</body>
</html>
